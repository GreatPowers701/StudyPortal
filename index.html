<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Study Portal - Multi-Test Manager</title>
    <link rel="icon" type="image/x-icon" href="https://cdn-icons-png.flaticon.com/512/19029/19029128.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDK -->
    <!-- Use compat builds (global `firebase`) so existing code works without module imports -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    <!-- Google Sign-In -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <!-- Google APIs Client (for Google Tasks) -->
    <script src="https://apis.google.com/js/api.js" async defer></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    animation: {
                        'bounce-short': 'bounce-short 0.5s ease-in-out 3',
                    },
                    keyframes: {
                        'bounce-short': {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        }
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap');

        body {
            font-family: 'Outfit', sans-serif;
            background-attachment: fixed;
        }

        /* Modern Glassmorphism */
        .glass {
            @apply bg-white/70 dark:bg-slate-900/60 backdrop-blur-xl border border-white/40 dark:border-white/10 shadow-lg;
        }

        .glass-hover {
            @apply hover:bg-white/80 dark:hover:bg-slate-900/80 transition duration-300;
        }

        .card-shadow {
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07);
        }

        /* Input & Button Base Styles */
        .glass-input {
            @apply bg-white/50 dark:bg-black/20 border border-slate-200/60 dark:border-white/10 backdrop-blur-sm focus:bg-white/80 dark:focus:bg-black/40 transition-all duration-300;
        }

        /* Scrollbars */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            @apply bg-slate-300/50 dark:bg-slate-600/50 rounded-full hover:bg-slate-400/80 dark:hover:bg-slate-500/80 transition;
        }

        /* Animations */
        @keyframes float {
            0% {
                transform: translateY(0px);
            }

            50% {
                transform: translateY(-10px);
            }

            100% {
                transform: translateY(0px);
            }
        }

        .animate-float {
            animation: float 6s ease-in-out infinite;
        }

        /* Selection */
        ::selection {
            @apply bg-violet-500/30 text-violet-900 dark:text-violet-100;
        }

        /* Mark for review tint */
        .marked-tint {
            @apply bg-indigo-50/80 dark:bg-indigo-900/40 border-indigo-400 dark:border-indigo-500 shadow-[0_0_25px_rgba(99,102,241,0.25)] !important;
        }

        /* Starred indicator glow */
        .starred-glow {
            @apply border-amber-400 dark:border-amber-400 shadow-[0_0_30px_rgba(245,158,11,0.4)] !important;
        }
    </style>
</head>

<body
    class="bg-gradient-to-br from-indigo-50 via-purple-50/50 to-pink-50 dark:from-slate-950 dark:via-slate-900 dark:to-slate-950 min-h-screen text-slate-800 dark:text-slate-100 transition-colors duration-300 selection:bg-violet-500/30">

    <!-- Autosave Indicator -->
    <div id="autosave-indicator"
        class="fixed bottom-6 right-6 bg-slate-900/80 dark:bg-white/80 backdrop-blur-md text-white dark:text-slate-900 text-[10px] px-4 py-1.5 rounded-full font-bold uppercase tracking-widest opacity-0 z-[100] pointer-events-none shadow-lg transform transition-all duration-300 translate-y-2">
        Saved ✓
    </div>

    <div id="app" class="w-full px-6 py-8">
        <!-- Navigation Header -->
        <header class="flex flex-col md:flex-row justify-between items-center mb-10 gap-4">
            <div id="header-left" class="flex items-center gap-4">
                <div
                    class="p-2 bg-gradient-to-br from-violet-600 to-indigo-600 rounded-xl shadow-lg shadow-indigo-500/20 text-white">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                    </svg>
                </div>
                <div>
                    <h1
                        class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-slate-900 to-slate-700 dark:from-white dark:to-slate-300 tracking-tight">
                        Study Portal</h1>
                    <p class="text-[10px] uppercase tracking-widest text-slate-400 font-semibold">Multi-Test Manager</p>
                </div>
            </div>
            <div id="header-right"
                class="flex items-center gap-3 flex-wrap justify-center md:justify-end w-full md:w-auto">
                <!-- Version Badge -->
                <div
                    class="text-[9px] text-slate-400 dark:text-slate-500 font-bold px-2 py-1 rounded-md bg-white/50 dark:bg-slate-800/50 border border-slate-200/50 dark:border-slate-700/50 backdrop-blur-sm whitespace-nowrap uppercase tracking-widest">
                    v3.0 Beta</div>
                <!-- Auth Status -->
                <div id="auth-container" class="flex items-center gap-3 flex-wrap justify-center md:justify-end">
                    <div id="user-info"
                        class="hidden items-center gap-3 pl-2 pr-2 py-1.5 bg-white/60 dark:bg-slate-800/60 backdrop-blur-md rounded-full border border-white/20 dark:border-white/5 shadow-sm">
                        <img id="user-avatar" class="w-7 h-7 rounded-full ring-2 ring-white dark:ring-slate-700"
                            alt="User">
                        <span id="user-name"
                            class="text-xs font-semibold text-slate-700 dark:text-slate-200 hidden sm:inline"></span>
                        <button onclick="signOut()"
                            class="ml-1 w-7 h-7 flex items-center justify-center rounded-full bg-slate-100 dark:bg-slate-700 text-slate-500 hover:bg-rose-100 hover:text-rose-500 dark:hover:bg-rose-900/30 dark:hover:text-rose-400 transition"
                            title="Sign Out">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20"
                                fill="currentColor">
                                <path fill-rule="evenodd"
                                    d="M3 3a1 1 0 00-1 1v12a1 1 0 102 0V4a1 1 0 00-1-1zm10.293 9.293a1 1 0 001.414 1.414l3-3a1 1 0 000-1.414l-3-3a1 1 0 10-1.414 1.414L14.586 9H7a1 1 0 100 2h7.586l-1.293 1.293z"
                                    clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                    <button id="google-signin-btn"
                        class="text-xs sm:text-sm bg-slate-900 dark:bg-white text-white dark:text-slate-900 px-5 py-2 rounded-full font-bold hover:shadow-lg hover:-translate-y-0.5 transition-all duration-300">Sign
                        in</button>
                </div>
                <!-- Theme Toggle -->
                <button onclick="toggleTheme()"
                    class="p-2 rounded-full bg-white/60 dark:bg-slate-800/60 border border-slate-200/50 dark:border-slate-700/50 text-slate-500 dark:text-slate-400 hover:bg-white hover:shadow-md dark:hover:bg-slate-800 transition backdrop-blur-sm"
                    title="Toggle Theme">
                    <svg id="theme-icon-sun" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 hidden dark:block"
                        fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364-6.364l-.707.707M6.343 17.657l-.707.707M16.243 16.243l.707.707M7.757 7.757l.707.707M12 8a4 4 0 100 8 4 4 0 000-8z" />
                    </svg>
                    <svg id="theme-icon-moon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 block dark:hidden"
                        fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                    </svg>
                </button>
                <div class="h-6 w-px bg-slate-200 dark:bg-slate-700 mx-1 hidden sm:block"></div>
                <button onclick="exportLibrary()"
                    class="p-2 rounded-full bg-white/60 dark:bg-slate-800/60 border border-slate-200/50 dark:border-slate-700/50 text-slate-500 hover:text-blue-600 dark:text-slate-400 dark:hover:text-blue-400 hover:bg-white hover:shadow-md dark:hover:bg-slate-800 transition backdrop-blur-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                    </svg>
                </button>
                <label
                    class="p-2 rounded-full bg-white/60 dark:bg-slate-800/60 border border-slate-200/50 dark:border-slate-700/50 text-slate-500 hover:text-emerald-600 dark:text-slate-400 dark:hover:text-emerald-400 hover:bg-white hover:shadow-md dark:hover:bg-slate-800 transition backdrop-blur-sm cursor-pointer">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m-4-4v12" />
                    </svg>
                    <input type="file" id="importLibraryInput" class="hidden" onchange="importLibrary(event)">
                </label>
            </div>
        </header>

        <!-- View: Home Screen -->
        <main id="view-home" class="space-y-8 animate-fade-in">
            <!-- Top Row: Add Test + To-Do (stacked on mobile, side-by-side on larger screens) -->
            <section class="grid grid-cols-1 lg:grid-cols-2 gap-8 items-start">
                <!-- Upload Section -->
                <div class="glass p-8 rounded-3xl card-shadow text-center relative overflow-hidden group">
                    <div
                        class="absolute inset-0 bg-gradient-to-br from-blue-500/5 to-purple-500/5 opacity-0 group-hover:opacity-100 transition duration-500">
                    </div>

                    <div class="relative z-10">
                        <div
                            class="w-16 h-16 bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-sm group-hover:scale-110 transition duration-300">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                        </div>
                        <h2 class="text-xl font-bold mb-2 dark:text-white">Add New Test</h2>
                        <p class="text-slate-500 dark:text-slate-400 text-sm mb-6 max-w-sm mx-auto">Upload a JSON answer
                            key to create a new practice session and track your progress.</p>

                        <div class="flex flex-col sm:flex-row items-center justify-center gap-3 mb-6">
                            <div class="w-full sm:w-72 space-y-3">
                                <input type="text" id="newTestTitle" placeholder="Test Title (e.g. Physics Mock 1)"
                                    class="glass-input w-full px-4 py-3 rounded-xl text-slate-900 dark:text-white outline-none placeholder:text-slate-400 dark:placeholder:text-slate-500 text-sm">
                                <input type="text" id="newTestSubject" placeholder="Subject (optional, e.g. Physics)"
                                    class="glass-input w-full px-4 py-3 rounded-xl text-slate-900 dark:text-white outline-none placeholder:text-slate-400 dark:placeholder:text-slate-500 text-sm">
                            </div>
                            <input type="file" id="newTestFile" accept=".json" class="hidden">
                            <button onclick="document.getElementById('newTestFile').click()"
                                class="w-full sm:w-auto self-stretch sm:self-center bg-gradient-to-r from-blue-600 to-indigo-600 text-white px-6 py-3 rounded-xl font-bold hover:shadow-lg hover:shadow-blue-500/30 hover:-translate-y-0.5 transition-all duration-300 flex items-center justify-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                                    stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                                </svg>
                                Upload
                            </button>
                        </div>

                        <div class="pt-5 border-t border-slate-200/50 dark:border-slate-700/50">
                            <button onclick="copyExtractionPrompt()"
                                class="text-xs text-slate-500 dark:text-slate-400 font-semibold hover:text-blue-600 dark:hover:text-blue-400 transition flex items-center gap-2 mx-auto group/btn">
                                <span class="group-hover/btn:underline decoration-blue-400/50 underline-offset-4">Need
                                    to extract answers from images?</span>
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none"
                                    viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3" />
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- To-Do List Section (Google Tasks) -->
                <div class="glass p-8 rounded-3xl card-shadow relative overflow-hidden h-full flex flex-col">
                    <div class="flex items-center justify-between gap-3 mb-4">
                        <div class="flex items-center gap-3">
                            <div
                                class="w-10 h-10 bg-emerald-100 dark:bg-emerald-900/30 text-emerald-600 dark:text-emerald-400 rounded-xl flex items-center justify-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                                    stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />
                                </svg>
                            </div>
                            <h2 class="text-xl font-bold dark:text-white">To‑Do List</h2>
                        </div>
                        <button id="tasks-connect-btn" onclick="handleTasksAuthClick()"
                            class="text-xs bg-white/50 dark:bg-slate-800/50 border border-slate-200/60 dark:border-slate-700/60 text-slate-600 dark:text-slate-300 px-3 py-1.5 rounded-lg font-semibold hover:bg-white dark:hover:bg-slate-800 transition whitespace-nowrap backdrop-blur-sm">
                            Connect Google Tasks
                        </button>
                    </div>

                    <div id="tasks-status"
                        class="text-[11px] mb-4 font-medium px-3 py-1.5 rounded-lg bg-amber-50/50 dark:bg-amber-900/20 text-amber-600 dark:text-amber-400 border border-amber-100 dark:border-amber-900/30 inline-block self-start">
                        Google Tasks not connected. You can still add local to‑dos.
                    </div>

                    <!-- Add To-Do -->
                    <div class="flex flex-col sm:flex-row gap-2 mb-6">
                        <input id="todo-input" type="text" placeholder="New task..."
                            class="glass-input flex-1 px-4 py-2.5 rounded-xl text-sm text-slate-900 dark:text-white outline-none placeholder:text-slate-400">
                        <input id="todo-due-date" type="date"
                            class="glass-input px-4 py-2.5 rounded-xl text-sm text-slate-900 dark:text-white outline-none">
                        <button onclick="addTodo()"
                            class="bg-slate-900 dark:bg-white text-white dark:text-slate-900 px-5 py-2.5 rounded-xl text-sm font-bold hover:bg-slate-800 dark:hover:bg-slate-200 transition shadow-lg whitespace-nowrap">
                            Add
                        </button>
                    </div>

                    <!-- Task List -->
                    <div id="todo-list"
                        class="flex-1 max-h-64 overflow-y-auto custom-scrollbar space-y-2.5 text-sm text-slate-700 dark:text-slate-200 pr-1">
                        <!-- Tasks rendered here -->
                    </div>

                    <div
                        class="mt-5 pt-3 border-t border-slate-200/50 dark:border-slate-700/50 flex items-center justify-between text-[11px] text-slate-400 dark:text-slate-500 font-medium uppercase tracking-wider">
                        <span id="todo-count">0 tasks</span>
                        <button onclick="clearCompletedTodos()" class="hover:text-rose-500 transition">Clear
                            completed</button>
                    </div>
                </div>
            </section>

            <!-- Library Grid -->
            <section>
                <div class="flex items-center justify-between mb-8">
                    <h2
                        class="text-3xl font-black flex items-center gap-3 bg-clip-text text-transparent bg-gradient-to-r from-slate-900 to-slate-700 dark:from-white dark:to-slate-300">
                        My Tests
                        <span id="test-count"
                            class="bg-white/50 dark:bg-slate-800/50 backdrop-blur-sm border border-slate-200/50 dark:border-slate-700/50 text-slate-500 dark:text-slate-400 text-sm px-3 py-1 rounded-full font-bold shadow-sm">0</span>
                    </h2>

                    <!-- Search/Filter Placeholder -->
                    <div class="hidden sm:flex items-center gap-2">
                        <div class="relative group">
                            <input type="text" id="search-input" placeholder="Search tests..."
                                oninput="handleSearch(this.value)"
                                class="glass-input px-4 py-2 rounded-xl text-sm w-48 focus:w-64 transition-all duration-300 pl-10 text-slate-700 dark:text-slate-200 placeholder:text-slate-400">
                            <svg xmlns="http://www.w3.org/2000/svg"
                                class="h-4 w-4 absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" fill="none"
                                viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                            </svg>
                        </div>
                    </div>
                </div>

                <div id="test-library" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Cards injected here -->
                </div>
            </section>
        </main>

        <!-- View: Test Workspace -->
        <main id="view-test" class="hidden space-y-6 animate-fade-in relative">
            <div class="flex flex-wrap justify-between items-center gap-4 mb-2">
                <button onclick="goHome()"
                    class="flex items-center gap-2 text-slate-500 dark:text-slate-400 hover:text-slate-900 dark:hover:text-white font-medium transition group px-3 py-2 rounded-xl hover:bg-white/50 dark:hover:bg-slate-800/50">
                    <svg xmlns="http://www.w3.org/2000/svg"
                        class="h-5 w-5 group-hover:-translate-x-1 transition-transform" viewBox="0 0 20 20"
                        fill="currentColor">
                        <path fill-rule="evenodd"
                            d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z"
                            clip-rule="evenodd" />
                    </svg>
                    Back to Library
                </button>
                <div class="flex items-center gap-3">
                    <!-- Goals and Timer Info -->
                    <div id="timer-display-area" class="flex items-center gap-3">
                        <div id="active-goal-stats"
                            class="hidden items-center gap-2 bg-slate-900 dark:bg-white text-white dark:text-slate-900 px-3 py-1.5 rounded-lg text-xs font-bold uppercase tracking-wider shadow-lg">
                            Goal: <span id="display-goal-num">0</span> Qs
                        </div>
                        <div
                            class="flex items-center bg-white/80 dark:bg-slate-800/80 backdrop-blur-md border border-slate-200/50 dark:border-slate-700/50 rounded-xl overflow-hidden h-10 shadow-sm">
                            <div id="timer-box"
                                class="flex items-center gap-2 px-4 py-1.5 text-slate-700 dark:text-slate-200 font-mono text-sm cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700/50 transition border-r border-slate-200/50 dark:border-slate-700/50"
                                onclick="openTimerSettings()" title="Timer Settings">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-slate-400" fill="none"
                                    viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                <span id="test-timer" class="font-bold tracking-wider">00:00:00</span>
                            </div>
                            <button id="timer-toggle-btn" onclick="toggleTimer()"
                                class="px-3 hover:bg-slate-50 dark:hover:bg-slate-700/50 transition text-slate-600 dark:text-slate-400 h-full flex items-center justify-center"
                                title="Start/Stop Timer">
                                <svg id="timer-play-icon" xmlns="http://www.w3.org/2000/svg"
                                    class="h-5 w-5 text-emerald-500" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd"
                                        d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z"
                                        clip-rule="evenodd" />
                                </svg>
                                <svg id="timer-stop-icon" xmlns="http://www.w3.org/2000/svg"
                                    class="h-5 w-5 hidden text-amber-500" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd"
                                        d="M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a1 1 0 00-1 1v4a1 1 0 001 1h4a1 1 0 001-1V8a1 1 0 00-1-1H8z"
                                        clip-rule="evenodd" />
                                </svg>
                            </button>
                        </div>
                    </div>

                    <div class="flex items-center gap-2">
                        <button onclick="openKeyViewer(activeTestId)"
                            class="p-2 rounded-xl bg-white/60 dark:bg-slate-800/60 hover:bg-white dark:hover:bg-slate-800 border border-slate-200/50 dark:border-slate-700/50 text-slate-500 dark:text-slate-400 transition"
                            title="View answer key">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                            </svg>
                        </button>
                        <button onclick="exportSingleTest(activeTestId)"
                            class="p-2 rounded-xl bg-white/60 dark:bg-slate-800/60 hover:bg-white dark:hover:bg-slate-800 border border-slate-200/50 dark:border-slate-700/50 text-slate-500 dark:text-slate-400 transition"
                            title="Export">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                            </svg>
                        </button>
                        <button onclick="showReport()"
                            class="p-2 rounded-xl bg-emerald-100 dark:bg-emerald-900/30 text-emerald-600 dark:text-emerald-400 hover:bg-emerald-200 dark:hover:bg-emerald-900/50 transition font-bold flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                            </svg>
                        </button>
                    </div>
                </div>
            </div>

            <div id="test-workspace-header" class="space-y-4">
                <div class="flex items-center gap-3">
                    <h2 id="active-test-title" class="text-3xl font-black text-slate-900 dark:text-white leading-tight">
                    </h2>
                    <button onclick="openEditTest(activeTestId)"
                        class="p-2 rounded-xl text-slate-400 hover:text-blue-600 hover:bg-blue-50 dark:hover:bg-blue-900/20 transition group"
                        title="Edit Test Details">
                        <svg xmlns="http://www.w3.org/2000/svg"
                            class="h-5 w-5 group-hover:scale-110 transition-transform" viewBox="0 0 20 20"
                            fill="currentColor">
                            <path
                                d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" />
                        </svg>
                    </button>
                </div>

                <!-- Sticky Top Bar for Sections, Submit, and Filters -->
                <div
                    class="sticky top-4 z-40 bg-white/80 dark:bg-slate-900/80 backdrop-blur-xl rounded-2xl border border-white/20 dark:border-slate-700/50 p-2 shadow-lg shadow-slate-900/5 space-y-3 transition-all duration-300">
                    <div class="flex items-center justify-between flex-wrap gap-4 px-2">
                        <div class="flex gap-2 overflow-x-auto pb-1 custom-scrollbar flex-1 no-scrollbar"
                            id="section-tabs"></div>
                        <button onclick="submitAllAttempted()"
                            class="text-xs bg-indigo-50 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-300 border border-indigo-200 dark:border-indigo-800 px-4 py-2 rounded-lg font-bold hover:bg-indigo-100 dark:hover:bg-indigo-900/50 transition whitespace-nowrap uppercase tracking-wide">
                            Submit Section
                        </button>
                        <button id="btn-toggle-pdf" onclick="togglePdfView()"
                            class="hidden text-xs bg-rose-50 dark:bg-rose-900/30 text-rose-600 dark:text-rose-300 border border-rose-200 dark:border-rose-800 px-3 py-2 rounded-lg font-bold hover:bg-rose-100 dark:hover:bg-rose-900/50 transition whitespace-nowrap uppercase tracking-wide gap-1 items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                            </svg>
                            View PDF
                        </button>
                    </div>

                    <!-- Sorting/Filters Row -->
                    <div class="flex flex-wrap items-center gap-2 px-2 pb-1">
                        <span
                            class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mr-2 flex items-center gap-1">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
                            </svg>
                            Filters
                        </span>
                        <button onclick="toggleFilter('wrong')" id="filter-wrong"
                            class="text-[11px] px-3 py-1 rounded-full border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-400 font-semibold transition hover:bg-slate-100 dark:hover:bg-slate-700 active:scale-95">
                            Wrong
                        </button>
                        <button onclick="toggleFilter('unattempted')" id="filter-unattempted"
                            class="text-[11px] px-3 py-1 rounded-full border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-400 font-semibold transition hover:bg-slate-100 dark:hover:bg-slate-700 active:scale-95">
                            Unattempted
                        </button>
                        <button onclick="toggleFilter('marked')" id="filter-marked"
                            class="text-[11px] px-3 py-1 rounded-full border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-400 font-semibold transition hover:bg-slate-100 dark:hover:bg-slate-700 active:scale-95">
                            Marked
                        </button>
                        <button onclick="toggleFilter('starred')" id="filter-starred"
                            class="text-[11px] px-3 py-1 rounded-full border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-400 font-semibold transition hover:bg-slate-100 dark:hover:bg-slate-700 active:scale-95 flex items-center gap-1">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 text-amber-500" viewBox="0 0 20 20"
                                fill="currentColor">
                                <path
                                    d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                            </svg>
                            Starred
                        </button>
                        <button onclick="clearFilters()" id="filter-clear"
                            class="hidden text-[10px] px-3 py-1 rounded-full text-rose-500 font-bold hover:bg-rose-50 dark:hover:bg-rose-900/20 transition ml-auto uppercase tracking-wide">
                            Reset
                        </button>
                    </div>
                </div>
            </div>

            <div class="flex flex-col lg:flex-row gap-6 relative">
                <!-- PDF Viewer Container (Hidden by default) -->
                <div id="pdf-container" class="hidden lg:w-3/4 h-[85vh] sticky top-24 transition-all duration-300">
                    <div
                        class="glass h-full rounded-2xl overflow-auto custom-scrollbar shadow-xl border border-slate-200/50 dark:border-slate-700/50 flex flex-col relative group">
                        <!-- Controls Overlay -->
                        <div
                            class="absolute top-4 right-4 z-10 flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                            <button onclick="zoomPdf(0.2)"
                                class="p-2 bg-slate-900/80 hover:bg-slate-900 text-white rounded-lg backdrop-blur-sm shadow-lg hover:scale-105 transition">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20"
                                    fill="currentColor">
                                    <path fill-rule="evenodd"
                                        d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z"
                                        clip-rule="evenodd" />
                                </svg>
                            </button>
                            <button onclick="zoomPdf(-0.2)"
                                class="p-2 bg-slate-900/80 hover:bg-slate-900 text-white rounded-lg backdrop-blur-sm shadow-lg hover:scale-105 transition">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20"
                                    fill="currentColor">
                                    <path fill-rule="evenodd" d="M5 10a1 1 0 011-1h8a1 1 0 110 2H6a1 1 0 01-1-1z"
                                        clip-rule="evenodd" />
                                </svg>
                            </button>
                            <button onclick="togglePdfView()"
                                class="p-2 bg-rose-500/80 hover:bg-rose-600 text-white rounded-lg backdrop-blur-sm shadow-lg hover:scale-105 transition">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                                    stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                        </div>
                        <iframe id="pdf-frame" class="w-full h-full bg-slate-50 dark:bg-slate-900" src=""
                            frameborder="0" allow="autoplay">
                        </iframe>
                        <div id="pdf-placeholder"
                            class="hidden absolute inset-0 flex items-center justify-center bg-slate-50 dark:bg-slate-800 text-slate-400">
                            <p class="text-sm">No PDF assigned</p>
                        </div>

                        <!-- View Solutions Button -->
                        <button id="btn-view-solutions" onclick="openSolutionPdf()"
                            class="absolute bottom-6 left-6 z-20 hidden items-center gap-2 bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2.5 rounded-xl font-bold hover:scale-105 hover:shadow-lg transition-all duration-300 shadow-md">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                            View Solutions
                        </button>
                    </div>
                </div>

                <!-- Questions Grid -->
                <div id="question-grid-container" class="w-full transition-all duration-300">
                    <div id="question-grid"
                        class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-3 gap-6 pb-20">
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <!-- Report Modal -->
    <div id="reportModal"
        class="fixed inset-0 bg-slate-900/60 dark:bg-black/80 backdrop-blur-sm hidden items-center justify-center z-50 p-4 transition-all duration-300">
        <div
            class="glass dark:bg-slate-900/95 rounded-3xl max-w-3xl w-full p-8 relative max-h-[90vh] overflow-y-auto card-shadow border border-slate-200/50 dark:border-slate-700/50 animate-scale-in">
            <button onclick="closeModal('reportModal')"
                class="absolute top-6 right-6 p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-400 hover:text-slate-600 dark:hover:text-slate-200 transition">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd"
                        d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                        clip-rule="evenodd" />
                </svg>
            </button>
            <h3 class="text-3xl font-black mb-8 text-slate-900 dark:text-white tracking-tight">Performance Summary</h3>
            <div id="reportContent" class="space-y-6"></div>
            <button onclick="closeModal('reportModal')"
                class="mt-8 w-full bg-slate-900 dark:bg-white text-white dark:text-slate-900 py-4 rounded-2xl font-bold hover:shadow-lg hover:-translate-y-0.5 transition-all duration-300">Done</button>
        </div>
    </div>

    <!-- Answer Key Viewer Modal -->
    <div id="keyViewerModal"
        class="fixed inset-0 bg-slate-900/60 dark:bg-black/80 backdrop-blur-sm hidden items-center justify-center z-50 p-4 transition-all duration-300">
        <div
            class="glass dark:bg-slate-900/95 rounded-3xl max-w-4xl w-full p-8 relative max-h-[90vh] flex flex-col card-shadow border border-slate-200/50 dark:border-slate-700/50 animate-scale-in">
            <button onclick="closeModal('keyViewerModal')"
                class="absolute top-6 right-6 p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-400 hover:text-slate-600 dark:hover:text-slate-200 transition">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd"
                        d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                        clip-rule="evenodd" />
                </svg>
            </button>
            <h3 id="keyViewerTitle" class="text-2xl font-bold mb-6 text-slate-900 dark:text-white pr-10">Answer Key</h3>

            <div id="keyViewerContent" class="space-y-6 overflow-y-auto custom-scrollbar pr-2 flex-1">
                <!-- Answer key rows injected here -->
            </div>

            <div class="flex gap-4 mt-8 pt-4 border-t border-slate-200/50 dark:border-slate-700/50">
                <button onclick="closeModal('keyViewerModal')"
                    class="flex-1 bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 py-3 rounded-xl font-bold hover:bg-slate-200 dark:hover:bg-slate-700 transition">Close</button>
                <button id="downloadKeyBtn"
                    class="flex-1 bg-blue-600 text-white py-3 rounded-xl font-bold flex items-center justify-center gap-2 hover:shadow-lg shadow-blue-500/20 hover:-translate-y-0.5 transition-all duration-300">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                    </svg>
                    Download JSON
                </button>
            </div>
        </div>
    </div>

    <!-- Timer/Goal Settings Modal -->
    <div id="timerSettingsModal"
        class="fixed inset-0 bg-slate-900/60 dark:bg-black/80 backdrop-blur-sm hidden items-center justify-center z-50 p-4 transition-all duration-300">
        <div
            class="glass dark:bg-slate-900/95 rounded-3xl max-w-md w-full p-8 relative card-shadow border border-slate-200/50 dark:border-slate-700/50 animate-scale-in">
            <h3 class="text-2xl font-bold mb-6 text-slate-900 dark:text-white">Session Settings</h3>
            <div class="space-y-5">
                <div>
                    <label
                        class="block text-sm font-bold text-slate-500 dark:text-slate-400 mb-2 uppercase tracking-wide">Time
                        Limit (Minutes)</label>
                    <input type="number" id="input-timer-mins" placeholder="e.g. 30"
                        class="glass-input w-full px-4 py-3 rounded-xl text-slate-900 dark:text-white focus:ring-2 focus:ring-blue-500 outline-none placeholder:text-slate-400">
                    <p class="text-[11px] text-slate-400 mt-2 font-medium">Set to 0 to use a simple count-up timer.</p>
                </div>
                <div>
                    <label
                        class="block text-sm font-bold text-slate-500 dark:text-slate-400 mb-2 uppercase tracking-wide">Question
                        Goal</label>
                    <input type="number" id="input-goal-num" placeholder="e.g. 20"
                        class="glass-input w-full px-4 py-3 rounded-xl text-slate-900 dark:text-white focus:ring-2 focus:ring-blue-500 outline-none placeholder:text-slate-400">
                </div>
            </div>
            <div class="flex gap-3 mt-8">
                <button onclick="closeModal('timerSettingsModal')"
                    class="flex-1 bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-400 py-3 rounded-xl font-bold hover:bg-slate-200 dark:hover:bg-slate-700 transition">Cancel</button>
                <button onclick="saveTimerSettings()"
                    class="flex-1 bg-blue-600 text-white py-3 rounded-xl font-bold shadow-lg shadow-blue-500/30 hover:shadow-blue-500/40 hover:-translate-y-0.5 transition-all duration-300">Save</button>
            </div>
        </div>
    </div>

    <!-- Edit Test Modal -->
    <div id="editTestModal"
        class="fixed inset-0 bg-slate-900/60 dark:bg-black/80 backdrop-blur-sm hidden items-center justify-center z-50 p-4 transition-all duration-300">
        <div
            class="glass dark:bg-slate-900/95 rounded-3xl max-w-md w-full p-8 relative card-shadow border border-slate-200/50 dark:border-slate-700/50 animate-scale-in">
            <button onclick="closeModal('editTestModal')"
                class="absolute top-6 right-6 p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-400 hover:text-slate-600 dark:hover:text-slate-200 transition">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd"
                        d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                        clip-rule="evenodd" />
                </svg>
            </button>
            <h3 class="text-2xl font-bold mb-6 text-slate-900 dark:text-white">Edit Test</h3>
            <div class="space-y-5">
                <div>
                    <label
                        class="block text-sm font-bold text-slate-500 dark:text-slate-400 mb-2 uppercase tracking-wide">Title</label>
                    <input type="text" id="edit-test-title"
                        class="glass-input w-full px-4 py-3 rounded-xl text-slate-900 dark:text-white focus:ring-2 focus:ring-blue-500 outline-none placeholder:text-slate-400">
                </div>
                <div>
                    <label
                        class="block text-sm font-bold text-slate-500 dark:text-slate-400 mb-2 uppercase tracking-wide">Subject</label>
                    <input type="text" id="edit-test-subject" placeholder="e.g. Physics"
                        class="glass-input w-full px-4 py-3 rounded-xl text-slate-900 dark:text-white focus:ring-2 focus:ring-blue-500 outline-none placeholder:text-slate-400">
                    <p class="text-[11px] text-slate-400 mt-2 font-medium">Leave blank for Uncategorised.</p>
                </div>
                <div>
                    <label
                        class="block text-sm font-bold text-slate-500 dark:text-slate-400 mb-2 uppercase tracking-wide">Reference
                        PDF Link</label>
                    <input type="text" id="edit-test-pdf" placeholder="Paste Google Drive Share Link..."
                        class="glass-input w-full px-4 py-3 rounded-xl text-slate-900 dark:text-white focus:ring-2 focus:ring-blue-500 outline-none placeholder:text-slate-400">
                    <p class="text-[11px] text-slate-400 mt-2 font-medium">Link must be publicly accessible (Anyone with
                        link).</p>
                </div>
                <div>
                    <label
                        class="block text-sm font-bold text-slate-500 dark:text-slate-400 mb-2 uppercase tracking-wide">Solution
                        PDF Link</label>
                    <input type="text" id="edit-test-solution-pdf" placeholder="Paste Google Drive Share Link..."
                        class="glass-input w-full px-4 py-3 rounded-xl text-slate-900 dark:text-white focus:ring-2 focus:ring-blue-500 outline-none placeholder:text-slate-400">
                </div>
            </div>
            <div class="flex gap-3 mt-8">
                <button onclick="closeModal('editTestModal')"
                    class="flex-1 bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-400 py-3 rounded-xl font-bold hover:bg-slate-200 dark:hover:bg-slate-700 transition">Cancel</button>
                <button onclick="saveTestEdits()"
                    class="flex-1 bg-blue-600 text-white py-3 rounded-xl font-bold shadow-lg shadow-blue-500/30 hover:shadow-blue-500/40 hover:-translate-y-0.5 transition-all duration-300">Save</button>
            </div>
        </div>
    </div>

    <!-- Solution PDF Modal -->
    <div id="solutionPdfModal"
        class="fixed inset-0 bg-slate-900/80 dark:bg-black/90 backdrop-blur-sm hidden items-center justify-center z-[70] p-4 transition-all duration-300">
        <div
            class="glass dark:bg-slate-900/95 rounded-3xl w-full max-w-5xl h-[90vh] flex flex-col relative card-shadow border border-slate-200/50 dark:border-slate-700/50 animate-scale-in">
            <div class="flex items-center justify-between p-4 border-b border-slate-200/50 dark:border-slate-700/50">
                <h3 class="text-xl font-bold text-slate-900 dark:text-white flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-emerald-500" fill="none"
                        viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    Solutions
                </h3>
                <button onclick="closeModal('solutionPdfModal')"
                    class="p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-400 hover:text-slate-600 dark:hover:text-slate-200 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd"
                            d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                            clip-rule="evenodd" />
                    </svg>
                </button>
            </div>
            <div class="flex-1 bg-slate-100 dark:bg-slate-900 relative">
                <iframe id="solution-pdf-frame" class="w-full h-full" src="" frameborder="0"></iframe>
            </div>
        </div>
    </div>

    <!-- Timer End Notification -->
    <div id="timerEndModal"
        class="fixed inset-0 bg-slate-900/60 dark:bg-black/80 backdrop-blur-sm hidden items-center justify-center z-[60] p-4 transition-all duration-300">
        <div
            class="glass dark:bg-slate-900/95 rounded-3xl max-w-sm w-full p-8 text-center card-shadow border border-slate-200/50 dark:border-slate-700/50 animate-bounce-short">
            <div
                class="w-20 h-20 bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 rounded-full flex items-center justify-center mx-auto mb-6 shadow-sm">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
            </div>
            <h3 class="text-2xl font-black text-slate-900 dark:text-white mb-3">Time's Up!</h3>
            <p class="text-slate-500 dark:text-slate-400 text-sm mb-8 px-4 leading-relaxed">Your set timer has ended.
                You can dismiss this and continue working on your test.</p>
            <button onclick="closeModal('timerEndModal')"
                class="w-full bg-blue-600 text-white py-3.5 rounded-xl font-bold shadow-lg shadow-blue-500/30 hover:shadow-blue-500/40 hover:-translate-y-0.5 transition-all duration-300">Got
                it</button>
        </div>
    </div>

    <script>
        // --- Core State Management ---
        let library = {};
        let activeTestId = null;
        let activeSection = null;
        let timerInterval = null;
        let saveTimeout = null;
        let currentTheme = localStorage.getItem('portal_theme') || 'light';
        let currentUser = null;
        let isSyncing = false;
        let auth = null;
        let db = null;
        let editingTestId = null;
        let searchTerm = '';

        // --- To-Do / Google Tasks State ---
        let todos = [];
        let editingTodoIndex = null; // Track which todo is being edited
        let tasksClientInitialized = false;
        let tasksSignedIn = false;
        let tokenClient;
        let accessToken = null;
        const TASKS_CLIENT_ID = '1068803170496-74g9qkb8851fbvamiduik6ik64opqu6e.apps.googleusercontent.com';
        const TASKS_API_KEY = 'AIzaSyAEw5jkjWOWj5yiBn-UB2GW-xSGZ6VBiKY';
        const TASKS_DISCOVERY_DOCS = ['https://www.googleapis.com/discovery/v1/apis/tasks/v1/rest'];
        const TASKS_SCOPES = 'https://www.googleapis.com/auth/tasks';

        // Active Filtering State
        let filters = {
            wrong: false,
            unattempted: false,
            marked: false,
            starred: false
        };

        // --- Firebase Configuration ---
        async function initializeFirebase() {
            try {
                // Wait briefly for the global `firebase` object to be available
                const start = Date.now();
                while (typeof window.firebase === 'undefined' && Date.now() - start < 5000) {
                    await new Promise(r => setTimeout(r, 200));
                }
                if (typeof window.firebase === 'undefined') {
                    console.error('Firebase global not found after 5s.');
                    alert('Firebase failed to load. Check the browser console and network tab for script loading errors.');
                    return;
                }

                const firebaseConfig = {
                    apiKey: "AIzaSyDXiGc0rzX6AgFMwKFr4M75V7obm7IlvCo",
                    authDomain: "study-portal-638a8.firebaseapp.com",
                    projectId: "study-portal-638a8",
                    storageBucket: "study-portal-638a8.firebasestorage.app",
                    messagingSenderId: "75874243415",
                    appId: "1:75874243415:web:7b5af602dafc7cb6de2412",
                    measurementId: "G-04Y81SX2K2"
                };

                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                auth = firebase.auth();
                db = firebase.firestore();

                // Setup auth state listener
                auth.onAuthStateChanged(async (user) => {
                    currentUser = user;
                    const userInfo = document.getElementById('user-info');
                    const signinBtn = document.getElementById('google-signin-btn');

                    if (user) {
                        userInfo.classList.remove('hidden');
                        userInfo.classList.add('flex');
                        signinBtn.classList.add('hidden');
                        document.getElementById('user-name').textContent = user.displayName || user.email;
                        document.getElementById('user-avatar').src = user.photoURL || 'https://via.placeholder.com/24';
                        await loadUserLibraryFromFirestore();
                        renderLibrary();
                    } else {
                        userInfo.classList.add('hidden');
                        userInfo.classList.remove('flex');
                        signinBtn.classList.remove('hidden');
                        library = {};
                        renderLibrary();
                    }
                });

                // Setup Google sign-in button
                const signinBtn = document.getElementById('google-signin-btn');
                if (signinBtn) {
                    signinBtn.onclick = async () => {
                        // OAuth popups won't work from file:// — guide the user
                        if (window.location.protocol === 'file:') {
                            alert('Google Sign-In requires the page to be served over HTTP/HTTPS (not file://).\nRun a quick local server (e.g. `python -m http.server 8000`) and open http://localhost:8000/checker.html');
                            return;
                        }

                        if (!auth) {
                            alert('Auth not initialized yet. Please refresh the page.');
                            return;
                        }

                        try {
                            const provider = new firebase.auth.GoogleAuthProvider();
                            await auth.signInWithPopup(provider);
                        } catch (error) {
                            console.error('Sign-in error:', error);
                            alert('Sign-in failed: ' + (error && error.message ? error.message : String(error)));
                        }
                    };
                }
            } catch (error) {
                console.error('Firebase initialization error:', error);
            }
        }

        function signOut() {
            if (auth) {
                auth.signOut()
                    .catch((error) => alert('Sign-out failed: ' + error.message));
            }
        }

        // --- Initialization ---
        window.onload = () => {
            applyTheme();
            setupFileUpload();
            initializeFirebase();
            loadLocalTodos();
            renderTodos();
            initializeGoogleTasksClient();
        };

        // --- Theme Logic ---
        function applyTheme() {
            if (currentTheme === 'dark') {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        }

        function toggleTheme() {
            currentTheme = currentTheme === 'light' ? 'dark' : 'light';
            localStorage.setItem('portal_theme', currentTheme);
            applyTheme();
        }

        function validateJSONSchema(data) {
            if (typeof data !== 'object' || data === null) return false;
            const sections = Object.keys(data);
            if (sections.length === 0) return false;
            for (let section of sections) {
                if (!Array.isArray(data[section].answers)) return false;
                if (!data[section].type) return false;
            }
            return true;
        }

        function setupFileUpload() {
            const fileIn = document.getElementById('newTestFile');
            const titleIn = document.getElementById('newTestTitle');
            const subjectIn = document.getElementById('newTestSubject');

            fileIn.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const title = titleIn.value.trim() || file.name.replace('.json', '');
                const subject = subjectIn ? subjectIn.value.trim() : '';
                const reader = new FileReader();
                reader.onload = (ev) => {
                    try {
                        const keyData = JSON.parse(ev.target.result);
                        if (!validateJSONSchema(keyData)) {
                            throw new Error("Invalid schema structure.");
                        }
                        const id = 'test_' + Date.now();

                        library[id] = {
                            id: id,
                            title: title,
                            subject: subject || '',
                            key: keyData,
                            progress: {},
                            timeSpent: 0,
                            timerMode: 'countup', // 'countup' or 'countdown'
                            timerLimit: 0, // in seconds
                            sessionGoal: 0,
                            timerRunning: false,
                            lastUpdate: Date.now()
                        };

                        saveAndSync();
                        titleIn.value = '';
                        if (subjectIn) subjectIn.value = '';
                        renderLibrary();
                    } catch (err) {
                        alert("Error: " + (err.message || "Invalid JSON format."));
                    }
                };
                reader.readAsText(file);
            };
        }

        // --- Firestore Data Sync ---
        async function loadUserLibraryFromFirestore() {
            if (!currentUser) return;

            try {
                const docRef = db.collection('users').doc(currentUser.uid);
                const docSnap = await docRef.get();

                if (docSnap.exists) {
                    library = docSnap.data().library || {};
                } else {
                    library = {};
                }
            } catch (error) {
                console.error('Error loading library from Firestore:', error);
                alert('Error loading data. Falling back to local version.');
            }
        }

        async function saveLibraryToFirestore() {
            if (!currentUser || isSyncing) return;

            isSyncing = true;
            try {
                await db.collection('users').doc(currentUser.uid).set({
                    library: library,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
                    email: currentUser.email
                });

                const indicator = document.getElementById('autosave-indicator');
                if (indicator) {
                    indicator.style.opacity = '1';
                    setTimeout(() => indicator.style.opacity = '0', 2000);
                }
            } catch (error) {
                console.error('Error saving to Firestore:', error);
            } finally {
                isSyncing = false;
            }
        }

        // --- Optimized Firestore Syncing ---
        function saveAndSync() {
            if (!currentUser) {
                // Fallback to localStorage if not signed in
                if (saveTimeout) clearTimeout(saveTimeout);
                saveTimeout = setTimeout(() => {
                    try {
                        localStorage.setItem('portal_library', JSON.stringify(library));
                        const indicator = document.getElementById('autosave-indicator');
                        if (indicator) {
                            indicator.style.opacity = '1';
                            setTimeout(() => indicator.style.opacity = '0', 2000);
                        }
                    } catch (e) {
                        console.error('Save error', e);
                    }
                }, 500);
                return;
            }

            if (saveTimeout) clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => {
                saveLibraryToFirestore();
            }, 500); // 500ms debounce
        }

        function formatTime(totalSeconds) {
            const isNegative = totalSeconds < 0;
            const absSecs = Math.abs(totalSeconds);
            const hrs = Math.floor(absSecs / 3600);
            const mins = Math.floor((absSecs % 3600) / 60);
            const secs = absSecs % 60;
            const timeStr = [hrs, mins, secs].map(v => v < 10 ? "0" + v : v).join(":");
            return isNegative ? "-" + timeStr : timeStr;
        }

        // --- Improved Answer Comparison ---
        function compareAnswers(user, key) {
            const cleanUser = Array.isArray(user) ? user.sort().join('') : user.trim().toUpperCase();
            const cleanKey = key.toString().toUpperCase().trim();
            if (cleanUser === cleanKey) return true;
            const numUser = parseFloat(cleanUser);
            const numKey = parseFloat(cleanKey);
            if (!isNaN(numUser) && !isNaN(numKey)) {
                return Math.abs(numUser - numKey) < 0.0001;
            }
            return false;
        }

        // --- Timer Logic ---
        function toggleTimer() {
            if (timerInterval) {
                stopTimer();
            } else {
                startTimer();
            }
        }

        function startTimer() {
            if (timerInterval) clearInterval(timerInterval);

            const playIcon = document.getElementById('timer-play-icon');
            const stopIcon = document.getElementById('timer-stop-icon');
            if (playIcon) playIcon.classList.add('hidden');
            if (stopIcon) stopIcon.classList.remove('hidden');

            if (activeTestId && library[activeTestId]) {
                library[activeTestId].timerRunning = true;
                library[activeTestId].lastUpdate = Date.now();
                saveAndSync();
            }

            timerInterval = setInterval(() => {
                if (activeTestId && library[activeTestId]) {
                    const test = library[activeTestId];
                    const now = Date.now();
                    const delta = Math.round((now - test.lastUpdate) / 1000);
                    test.lastUpdate = now;

                    if (test.timerMode === 'countdown') {
                        test.timerLimit -= delta;
                        test.timeSpent += delta;
                        const timerEl = document.getElementById('test-timer');
                        if (timerEl) timerEl.innerText = formatTime(test.timerLimit);
                        if (test.timerLimit <= 0) {
                            showTimerEnd();
                            stopTimer();
                        }
                    } else {
                        test.timeSpent += delta;
                        const timerEl = document.getElementById('test-timer');
                        if (timerEl) timerEl.innerText = formatTime(test.timeSpent);
                    }
                }
            }, 1000);
        }

        function stopTimer() {
            clearInterval(timerInterval);
            timerInterval = null;

            const playIcon = document.getElementById('timer-play-icon');
            const stopIcon = document.getElementById('timer-stop-icon');
            if (playIcon) playIcon.classList.remove('hidden');
            if (stopIcon) stopIcon.classList.add('hidden');

            if (activeTestId && library[activeTestId]) {
                library[activeTestId].timerRunning = false;
            }
            saveAndSync();
        }

        function openTimerSettings() {
            const test = library[activeTestId];
            document.getElementById('input-timer-mins').value = test.timerMode === 'countdown' ? Math.ceil(test.timerLimit / 60) : "";
            document.getElementById('input-goal-num').value = test.sessionGoal || "";
            document.getElementById('timerSettingsModal').classList.remove('hidden');
            document.getElementById('timerSettingsModal').classList.add('flex');
        }

        function saveTimerSettings() {
            const mins = parseInt(document.getElementById('input-timer-mins').value) || 0;
            const goal = parseInt(document.getElementById('input-goal-num').value) || 0;
            const test = library[activeTestId];

            const wasRunning = timerInterval !== null;
            stopTimer();

            if (mins > 0) {
                test.timerMode = 'countdown';
                test.timerLimit = mins * 60;
            } else {
                test.timerMode = 'countup';
            }

            test.sessionGoal = goal;
            saveAndSync();
            closeModal('timerSettingsModal');
            updateWorkspaceTimerUI();

            if (wasRunning) startTimer();
        }

        function updateWorkspaceTimerUI() {
            const test = library[activeTestId];
            const goalArea = document.getElementById('active-goal-stats');
            const goalNum = document.getElementById('display-goal-num');

            if (test.sessionGoal > 0) {
                goalArea.classList.remove('hidden');
                goalArea.classList.add('flex');
                goalNum.innerText = test.sessionGoal;
            } else {
                goalArea.classList.add('hidden');
                goalArea.classList.remove('flex');
            }

            const timerEl = document.getElementById('test-timer');
            if (timerEl) {
                timerEl.innerText = test.timerMode === 'countdown' ? formatTime(test.timerLimit) : formatTime(test.timeSpent);
            }

            const playIcon = document.getElementById('timer-play-icon');
            const stopIcon = document.getElementById('timer-stop-icon');
            if (timerInterval) {
                if (playIcon) playIcon.classList.add('hidden');
                if (stopIcon) stopIcon.classList.remove('hidden');
            } else {
                if (playIcon) playIcon.classList.remove('hidden');
                if (stopIcon) stopIcon.classList.add('hidden');
            }
        }

        function showTimerEnd() {
            const modal = document.getElementById('timerEndModal');
            if (modal) {
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            }
        }

        // --- Filtering Logic ---
        function toggleFilter(type) {
            filters[type] = !filters[type];
            updateFilterUI();
            renderQuestions();
        }

        function clearFilters() {
            filters = { wrong: false, unattempted: false, marked: false, starred: false };
            updateFilterUI();
            renderQuestions();
        }

        function updateFilterUI() {
            const anyActive = filters.wrong || filters.unattempted || filters.marked || filters.starred;
            document.getElementById('filter-clear').classList.toggle('hidden', !anyActive);

            Object.keys(filters).forEach(key => {
                const btn = document.getElementById(`filter-${key}`);
                if (btn) {
                    if (filters[key]) {
                        btn.classList.add('bg-blue-600', 'text-white', 'border-blue-600');
                        btn.classList.remove('bg-white', 'dark:bg-slate-800', 'text-slate-800', 'dark:text-slate-300', 'border-slate-200', 'dark:border-slate-700');
                    } else {
                        btn.classList.remove('bg-blue-600', 'text-white', 'border-blue-600');
                        btn.classList.add('bg-white', 'dark:bg-slate-800', 'text-slate-800', 'dark:text-slate-300', 'border-slate-200', 'dark:border-slate-700');
                    }
                }
            });
        }

        // --- Navigation ---
        function goHome() {
            stopTimer();
            saveAndSync();
            document.getElementById('view-home').classList.remove('hidden');
            document.getElementById('view-test').classList.add('hidden');
            activeTestId = null;
            clearFilters();
            // Clear search when going home? Optional. Let's keep it for now.
            // If we wanted to clear it: 
            // searchTerm = ''; 
            // document.getElementById('search-input').value = '';
            renderLibrary();
        }

        function handleSearch(val) {
            searchTerm = val.trim();
            renderLibrary();
        }

        function getEmbedLink(link) {
            if (!link) return '';
            try {
                let id = '';
                // Extract ID from standard Google Drive URLs
                // Pattern 1: .../file/d/FILE_ID/...
                if (link.includes('/file/d/')) {
                    id = link.split('/file/d/')[1].split('/')[0];
                }
                // Pattern 2: ...?id=FILE_ID...
                else if (link.includes('id=')) {
                    id = link.split('id=')[1].split('&')[0];
                }

                if (id) {
                    return `https://drive.google.com/file/d/${id}/preview`;
                }
                return link; // Fallback to original if ID extraction fails
            } catch (e) {
                console.warn("Error parsing PDF link:", e);
                return link;
            }
        }

        function openTest(id) {
            try {
                activeTestId = id;
                const test = library[id];
                document.getElementById('view-home').classList.add('hidden');
                document.getElementById('view-test').classList.remove('hidden');
                document.getElementById('active-test-title').innerText = test.title;

                // Handle PDF Button
                const pdfBtn = document.getElementById('btn-toggle-pdf');
                const solutionsBtn = document.getElementById('btn-view-solutions');
                const pdfFrame = document.getElementById('pdf-frame');
                const pdfContainer = document.getElementById('pdf-container');
                const gridContainer = document.getElementById('question-grid-container');
                const grid = document.getElementById('question-grid');

                // Reset View

                // Hide PDF
                pdfContainer.classList.add('hidden');

                // Expand Grid
                gridContainer.classList.add('w-full');
                gridContainer.classList.remove('lg:w-1/4', 'lg:w-1/2');

                // Restore Grid Columns
                grid.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-3 gap-6 pb-20';


                if (test.pdfLink) {
                    pdfBtn.classList.remove('hidden');
                    pdfBtn.classList.add('flex');
                    // Pre-convert link to embeddable preview format
                    const embedUrl = getEmbedLink(test.pdfLink);

                    // Only reload if the source is different to preserve scroll state
                    const currentSrc = pdfFrame.getAttribute('src');
                    if (currentSrc !== embedUrl) {
                        pdfFrame.src = embedUrl;
                    }

                    // Handle Solution PDF Button visibility
                    if (test.solutionPdfLink) {
                        solutionsBtn.classList.remove('hidden');
                        solutionsBtn.classList.add('flex');
                    } else {
                        solutionsBtn.classList.add('hidden');
                        solutionsBtn.classList.remove('flex');
                    }
                } else {
                    pdfBtn.classList.add('hidden');
                    pdfBtn.classList.remove('flex');
                    pdfFrame.src = '';
                }

                if (test.timerRunning) {
                    const now = Date.now();
                    const delta = Math.round((now - test.lastUpdate) / 1000);
                    test.lastUpdate = now;
                    if (test.timerMode === 'countdown') {
                        test.timerLimit -= delta;
                        test.timeSpent += delta;
                    } else {
                        test.timeSpent += delta;
                    }
                    updateWorkspaceTimerUI();
                    startTimer();
                } else {
                    updateWorkspaceTimerUI();
                }

                const sections = Object.keys(test.key).sort((a, b) => a.localeCompare(b));
                renderSectionTabs(sections);
                loadSection(sections[0]);
            } catch (err) {
                console.error("Failed to open test", err);
                goHome();
            }
        }



        function openSolutionPdf() {
            if (!activeTestId || !library[activeTestId] || !library[activeTestId].solutionPdfLink) return;

            const url = getEmbedLink(library[activeTestId].solutionPdfLink);
            const frame = document.getElementById('solution-pdf-frame');

            // Only reload if the source is different to preserve scroll state
            const currentSrc = frame.getAttribute('src');
            if (currentSrc !== url) {
                if (frame) frame.src = url;
            }

            const modal = document.getElementById('solutionPdfModal');
            if (modal) {
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            }
        }

        let currentZoom = 1;

        function zoomPdf(change) {
            const frame = document.getElementById('pdf-frame');
            if (!frame) return;
            currentZoom += change;
            if (currentZoom < 0.5) currentZoom = 0.5;
            if (currentZoom > 3) currentZoom = 3;

            frame.style.transform = `scale(${currentZoom})`;
            frame.style.transformOrigin = 'top left';
            // Increase container size to match scale so it scrolls properly
            frame.style.width = `${100 * currentZoom}%`;
            frame.style.height = `${100 * currentZoom}%`;
            // Actually for scale transform, we might want to just keep w-full h-full and let scale handle visual
            // But to scroll, the element must be physically larger.
            // A better approach for iframe zoom without altering flow might be just transforming
            // and ensuring parent overflows.
            // Let's reset width/height to 100% and just use scale, but we need a wrapper if we want to scroll *to* the zoomed parts?
            // Simplified:
            frame.style.width = `${100}%`;
            frame.style.height = `${100}%`;
            // Wait, if we scale(2), it looks 2x bigger. If the container is overflow-auto, we want scrollbars.
            // transform does not affect layout flow by default.
            // We need to set the browser to treat it as larger. 
            // Let's try just setting width/height directly for the iframe instead of transform?
            // No, iframe content doesn't always reflow.
            // Let's stick to transform but we need a wrapper to expand.
            // For now, let's just try simple scale and prompt user if it cuts off, 
            // OR simply:
            frame.style.width = `${100 / currentZoom}%`;
            frame.style.height = `${100 / currentZoom}%`;
            frame.style.transform = `scale(${currentZoom})`;
            // If we make it smaller physically but scale it up, it fills the original space "zoomed in".
            // If we want scrollbars, we need the container to see a larger element.

            // Re-think: Simplest zoom for iframes often is just width/height percentages if the source relies on viewport.
            // If it's a PDF Viewer (Chrome built-in), it has its own zoom usually but we can't access it cross-origin.
            // If we transform:scale(1.5), the element looks 1.5x bigger.
            // If we want to scroll, we need the parent to scroll.
            // Let's try the transform approach with origin top-left.
        }

        function togglePdfView() {
            const pdfContainer = document.getElementById('pdf-container');
            const gridContainer = document.getElementById('question-grid-container');
            const grid = document.getElementById('question-grid');
            const btn = document.getElementById('btn-toggle-pdf');

            const isHidden = pdfContainer.classList.contains('hidden');

            if (isHidden) {
                // Show PDF
                pdfContainer.classList.remove('hidden');

                // Shrink Grid
                gridContainer.classList.remove('w-full');
                gridContainer.classList.add('lg:w-1/4'); // Make it even smaller to give PDF more room

                // Adjust grid columns for narrower space - FORCE SINGLE COLUMN
                grid.className = 'grid grid-cols-1 gap-6 pb-20'; // Removed all responsive cols

                btn.classList.add('bg-indigo-100', 'text-indigo-700', 'dark:bg-indigo-900', 'dark:text-indigo-200');
                btn.classList.remove('bg-rose-50', 'text-rose-600');

                // Reset zoom on open
                currentZoom = 1;
                const frame = document.getElementById('pdf-frame');
                if (frame) {
                    frame.style.transform = 'scale(1)';
                    frame.style.width = '100%';
                    frame.style.height = '100%';
                }
            } else {
                // Hide PDF
                pdfContainer.classList.add('hidden');

                // Expand Grid
                gridContainer.classList.add('w-full');
                gridContainer.classList.remove('lg:w-1/4', 'lg:w-1/2');

                // Restore Grid Columns
                grid.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-3 gap-6 pb-20';

                btn.classList.remove('bg-indigo-100', 'text-indigo-700', 'dark:bg-indigo-900', 'dark:text-indigo-200');
                btn.classList.add('bg-rose-50', 'text-rose-600');
            }
        }

        // --- Rendering Home ---
        function renderLibrary() {
            try {
                const container = document.getElementById('test-library');
                const countEl = document.getElementById('test-count');
                container.innerHTML = '';

                let ids = Object.keys(library);

                // Filter by search term
                if (searchTerm) {
                    const lowerTerm = searchTerm.toLowerCase();
                    ids = ids.filter(id => {
                        const test = library[id];
                        return (test.title && test.title.toLowerCase().includes(lowerTerm)) ||
                            (test.subject && test.subject.toLowerCase().includes(lowerTerm));
                    });
                }

                countEl.innerText = ids.length;

                if (ids.length === 0) {
                    if (searchTerm) {
                        container.innerHTML = `<div class="col-span-full text-center py-20">
                            <div class="text-slate-300 dark:text-slate-600 mb-4">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto opacity-50" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                </svg>
                            </div>
                            <p class="text-slate-500 dark:text-slate-400 text-lg font-medium">No tests found matching "${searchTerm}"</p>
                            <button onclick="document.getElementById('search-input').value = ''; handleSearch('')" class="mt-4 text-blue-500 hover:underline">Clear Search</button>
                        </div>`;
                    } else {
                        container.innerHTML = `<div class="col-span-full text-center py-20">
                            <div class="text-slate-300 dark:text-slate-600 mb-4">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto opacity-50" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                                </svg>
                            </div>
                            <p class="text-slate-500 dark:text-slate-400 text-lg font-medium">No tests found</p>
                            <p class="text-slate-400 dark:text-slate-500 text-sm">Upload a JSON file to get started.</p>
                        </div>`;
                    }
                    return;
                }

                // Group tests by subject, with "Uncategorised" last
                const groups = {};
                ids.forEach(id => {
                    const test = library[id];
                    if (!test || !test.key) return;
                    const subjectLabel = (test.subject && String(test.subject).trim()) ? String(test.subject).trim() : 'Uncategorised';
                    if (!groups[subjectLabel]) groups[subjectLabel] = [];
                    groups[subjectLabel].push(id);
                });

                const allSubjects = Object.keys(groups).sort((a, b) => {
                    if (a === 'Uncategorised') return 1;
                    if (b === 'Uncategorised') return -1;
                    return a.localeCompare(b);
                });

                allSubjects.forEach(subjectName => {
                    const subjectTests = groups[subjectName];

                    // Subject header
                    const header = document.createElement('div');
                    header.className = 'col-span-full flex items-center gap-4 mb-4 mt-8 first:mt-0';
                    header.innerHTML = `
                        <h3 class="text-lg font-bold text-slate-700 dark:text-slate-200 flex items-center gap-2">
                            ${subjectName}
                            <span class="text-[10px] px-2 py-0.5 rounded-full bg-slate-100 dark:bg-slate-800 text-slate-500 dark:text-slate-400 font-extrabold uppercase tracking-widest border border-slate-200 dark:border-slate-700">${subjectTests.length}</span>
                        </h3>
                        <div class="h-px bg-slate-200/50 dark:bg-slate-700/50 flex-1"></div>
                    `;
                    container.appendChild(header);

                    // Sort tests alphabetically by title
                    subjectTests.sort((a, b) => {
                        const titleA = (library[a].title || "").toLowerCase();
                        const titleB = (library[b].title || "").toLowerCase();
                        return titleA.localeCompare(titleB);
                    });

                    subjectTests.forEach(id => {
                        const test = library[id];
                        if (!test || !test.key) return;

                        let totalQ = 0, attemptedQ = 0, completedQ = 0;

                        Object.keys(test.key).forEach(s => {
                            const sAns = test.key[s].answers;
                            const sProg = test.progress ? (test.progress[s] || {}) : {};
                            totalQ += sAns.length;

                            sAns.forEach((_, idx) => {
                                const q = sProg[idx];
                                if (q) {
                                    if (q.submitted) completedQ++;
                                    const hasAns = Array.isArray(q.userAns) ? q.userAns.length > 0 : (q.userAns && q.userAns.toString().trim() !== "");
                                    if (hasAns) attemptedQ++;
                                }
                            });
                        });

                        const completedPct = totalQ > 0 ? Math.round((completedQ / totalQ) * 100) : 0;
                        const attemptedPct = totalQ > 0 ? Math.round((attemptedQ / totalQ) * 100) : 0;
                        const subjectLabel = (test.subject && String(test.subject).trim()) ? String(test.subject).trim() : 'Uncategorised';

                        const card = document.createElement('div');
                        card.className = 'glass p-6 rounded-3xl cursor-pointer relative group transition-all duration-300 hover:scale-[1.02] hover:-translate-y-1 hover:shadow-xl hover:shadow-indigo-500/10 dark:hover:shadow-indigo-900/10 border-slate-100 dark:border-slate-800';
                        card.onclick = () => openTest(id);

                        // Card Header Background Gradient (Optional subtle touch)
                        const bgGradient = subjectName === 'Uncategorised'
                            ? 'from-slate-500/10 to-slate-500/5'
                            : 'from-blue-500/10 to-violet-500/5';

                        card.innerHTML = `
                        <div class="absolute inset-0 bg-gradient-to-br ${bgGradient} opacity-0 group-hover:opacity-100 transition duration-500 rounded-3xl"></div>
                        
                        <div class="relative z-10">
                            <div class="flex justify-between items-start mb-4">
                                <span class="inline-flex items-center px-2.5 py-1 rounded-lg bg-white/60 dark:bg-slate-800/60 border border-slate-200/50 dark:border-slate-700/50 backdrop-blur-sm text-[10px] uppercase tracking-widest font-bold text-slate-500 dark:text-slate-400 shadow-sm">
                                    ${subjectLabel}
                                </span>
                                
                                <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity duration-200 transform translate-x-2 group-hover:translate-x-0">
                                    <button onclick="event.stopPropagation(); openKeyViewer('${id}')" title="View answer key" class="p-1.5 rounded-lg text-slate-400 hover:text-emerald-600 hover:bg-emerald-50 dark:hover:bg-emerald-900/20 transition">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>
                                    </button>
                                    <button onclick="event.stopPropagation(); exportSingleTest('${id}')" title="Export Test" class="p-1.5 rounded-lg text-slate-400 hover:text-blue-600 hover:bg-blue-50 dark:hover:bg-blue-900/20 transition">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                                    </button>
                                    <button onclick="event.stopPropagation(); openEditTest('${id}')" title="Edit Test" class="p-1.5 rounded-lg text-slate-400 hover:text-amber-600 hover:bg-amber-50 dark:hover:bg-amber-900/20 transition">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                            <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" />
                                        </svg>
                                    </button>
                                    <button onclick="event.stopPropagation(); deleteTest('${id}')" title="Delete Test" class="p-1.5 rounded-lg text-slate-400 hover:text-rose-600 hover:bg-rose-50 dark:hover:bg-rose-900/20 transition">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                    </button>
                                </div>
                            </div>

                            <h3 class="font-bold text-lg mb-4 text-slate-800 dark:text-gray-100 pr-2 leading-snug group-hover:text-indigo-600 dark:group-hover:text-indigo-400 transition">${test.title}</h3>

                            <div class="space-y-3">
                                <div class="flex justify-between text-[11px] font-bold text-slate-400 dark:text-slate-500 uppercase tracking-wider">
                                    <span>Progress</span>
                                    <span>${completedPct}%</span>
                                </div>
                                <div class="w-full h-2.5 bg-slate-100 dark:bg-black/40 rounded-full overflow-hidden relative shadow-inner">
                                    <!-- Attempted Layer -->
                                    <div class="absolute h-full bg-blue-400/30 dark:bg-blue-400/20 transition-all duration-700 ease-out" style="width: ${attemptedPct}%"></div>
                                    <!-- Submitted Layer -->
                                    <div class="absolute h-full bg-gradient-to-r from-blue-500 to-indigo-600 shadow-[0_0_10px_rgba(79,70,229,0.3)] transition-all duration-700 ease-out" style="width: ${completedPct}%"></div>
                                </div>
                                <div class="flex justify-between items-center mt-2">
                                    <div class="flex items-center gap-1.5">
                                        <div class="w-2 h-2 rounded-full ${completedPct === 100 ? 'bg-emerald-500' : (completedPct > 0 ? 'bg-amber-400' : 'bg-slate-300')}"></div>
                                        <span class="text-[10px] font-semibold text-slate-500 dark:text-slate-400">${completedQ}/${totalQ} Done</span>
                                    </div>
                                    <span class="font-mono text-[10px] font-medium text-slate-400 bg-slate-100 dark:bg-slate-800 px-1.5 py-0.5 rounded">${formatTime(test.timeSpent || 0)}</span>
                                </div>
                            </div>
                        </div>
                    `;
                        container.appendChild(card);
                    });
                });
            } catch (err) {
                console.error("Render Library Error", err);
            }
        }

        function openEditTest(id) {
            const test = library[id];
            if (!test) return;
            editingTestId = id;
            const titleInput = document.getElementById('edit-test-title');
            const subjectInput = document.getElementById('edit-test-subject');
            const pdfInput = document.getElementById('edit-test-pdf');
            const solutionPdfInput = document.getElementById('edit-test-solution-pdf');

            if (titleInput) titleInput.value = test.title || '';
            if (subjectInput) subjectInput.value = test.subject || '';
            if (pdfInput) pdfInput.value = test.pdfLink || '';
            if (solutionPdfInput) solutionPdfInput.value = test.solutionPdfLink || '';

            const modal = document.getElementById('editTestModal');
            if (modal) {
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            }
        }

        function saveTestEdits() {
            if (!editingTestId || !library[editingTestId]) {
                closeModal('editTestModal');
                editingTestId = null;
                return;
            }
            const test = library[editingTestId];
            const titleInput = document.getElementById('edit-test-title');
            const subjectInput = document.getElementById('edit-test-subject');
            const pdfInput = document.getElementById('edit-test-pdf');
            const solutionPdfInput = document.getElementById('edit-test-solution-pdf');

            const newTitle = titleInput ? titleInput.value.trim() : '';
            const newSubject = subjectInput ? subjectInput.value.trim() : '';
            const newPdf = pdfInput ? pdfInput.value.trim() : '';
            const newSolutionPdf = solutionPdfInput ? solutionPdfInput.value.trim() : '';

            if (newTitle) test.title = newTitle;
            test.subject = newSubject || '';
            const oldPdf = test.pdfLink;
            test.pdfLink = newPdf || '';

            const oldSolutionPdf = test.solutionPdfLink;
            test.solutionPdfLink = newSolutionPdf || '';

            saveAndSync();
            renderLibrary();

            // If currently viewing this test, update the UI immediately
            if (activeTestId === editingTestId) {
                document.getElementById('active-test-title').innerText = test.title;

                const pdfBtn = document.getElementById('btn-toggle-pdf');
                const pdfFrame = document.getElementById('pdf-frame');

                if (test.pdfLink) {
                    pdfBtn.classList.remove('hidden');
                    pdfBtn.classList.add('flex');
                    // Reload frame only if link actually changed
                    if (oldPdf !== test.pdfLink) {
                        const embedUrl = getEmbedLink(test.pdfLink);
                        pdfFrame.src = embedUrl;
                    }

                    // Update Solution Button Visibility
                    const solutionsBtn = document.getElementById('btn-view-solutions');
                    if (solutionsBtn) {
                        if (test.solutionPdfLink) {
                            solutionsBtn.classList.remove('hidden');
                            solutionsBtn.classList.add('flex');
                        } else {
                            solutionsBtn.classList.add('hidden');
                            solutionsBtn.classList.remove('flex');
                        }
                    }
                } else {
                    pdfBtn.classList.add('hidden');
                    pdfBtn.classList.remove('flex');
                    // Hide container if it was open
                    const pdfContainer = document.getElementById('pdf-container');
                    if (!pdfContainer.classList.contains('hidden')) {
                        togglePdfView(); // Close it
                    }
                    pdfFrame.src = '';
                }
            }

            closeModal('editTestModal');
            editingTestId = null;
        }

        function deleteTest(id) {
            if (confirm("Delete this test and all progress?")) {
                delete library[id];
                saveAndSync();
                renderLibrary();
            }
        }

        function copyExtractionPrompt() {
            const promptText = `You are extracting an answer key from screenshots of a test.
Carefully read the uploaded image(s) and convert the answers into a JSON object that matches EXACTLY the following schema:
{
"Section Name": {
"type": "single | multi | numerical",
"answers": [...]
}
}
Rules:

Detect section headers (e.g., "SECTION (B): MULTIPLE CHOICE QUESTIONS (MULTIPLE OPTIONS CORRECT)", "SECTION (C): ASSERTION-REASONING", etc.).
Use the section title as the JSON key
Determine question type:
If multiple options like "A, B, D" → type = "multi"
If single letter like "A" → type = "single"
If numbers or decimals → type = "numerical"
Preserve answer order strictly by question number.
For multi answers:
Remove spaces
Combine letters into a string (e.g., "ABD", "ACD").
For single answers:
Use a single letter string (e.g., "A").
For numerical answers:
Use numbers or decimal values exactly as shown.
Ignore formatting artifacts like dots, alignment marks, or page decorations.
Do NOT add explanations.
Output ONLY valid JSON — no markdown, no commentary.
Example format:
{
"Multi Correct": {
"type": "multi",
"answers": ["AD", "BD", "ACD"]
},
"Comprehension": {
"type": "single",
"answers": ["C", "A", "B"]
},
"Integer": {
"type": "numerical",
"answers": [4, 6, 3]
}
}
Now extract the answers from the uploaded screenshot(s).

Double-check for OCR mistakes before finalizing.

If uncertain about any answer, mark it as null instead of guessing.`;

            const textArea = document.createElement("textarea");
            textArea.value = promptText;
            textArea.style.position = "fixed";
            textArea.style.left = "-9999px";
            textArea.style.top = "0";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();

            try {
                document.execCommand('copy');
                const indicator = document.getElementById('autosave-indicator');
                if (indicator) {
                    const originalText = indicator.innerText;
                    indicator.innerText = 'Prompt Copied! ✓';
                    indicator.style.opacity = '1';
                    setTimeout(() => {
                        indicator.style.opacity = '0';
                        setTimeout(() => indicator.innerText = originalText, 300);
                    }, 2000);
                }
            } catch (err) {
                console.error('Copy failed', err);
            }

            document.body.removeChild(textArea);
        }

        // --- To-Do List (Local + Google Tasks) ---

        function loadLocalTodos() {
            try {
                const raw = localStorage.getItem('portal_todos');
                if (!raw) {
                    todos = [];
                    return;
                }
                const parsed = JSON.parse(raw);
                if (Array.isArray(parsed)) {
                    todos = parsed;
                } else {
                    todos = [];
                }
            } catch (e) {
                console.error('Failed to load todos from localStorage', e);
                todos = [];
            }
        }

        function saveLocalTodos() {
            try {
                localStorage.setItem('portal_todos', JSON.stringify(todos));
            } catch (e) {
                console.error('Failed to save todos', e);
            }
        }

        function renderTodos() {
            const listEl = document.getElementById('todo-list');
            const countEl = document.getElementById('todo-count');
            if (!listEl || !countEl) return;

            listEl.innerHTML = '';
            if (!todos.length) {
                listEl.innerHTML = `<div class="text-xs text-slate-400 dark:text-slate-500 italic">No tasks yet. Add your first to‑do above.</div>`;
                countEl.innerText = '0 tasks';
                return;
            }

            todos.forEach((t, idx) => {
                const row = document.createElement('div');
                row.className = 'flex items-center gap-2 bg-white dark:bg-slate-800/80 border border-slate-200 dark:border-slate-700 rounded-lg px-3 py-2';

                if (editingTodoIndex === idx) {
                    // Edit Mode UI
                    row.innerHTML = `
                        <input type="text" id="edit-todo-text-${idx}" value="${t.text}" class="flex-1 px-2 py-1 rounded border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-900 text-xs text-slate-900 dark:text-white outline-none focus:ring-1 focus:ring-blue-500">
                        <input type="date" id="edit-todo-date-${idx}" value="${t.due || ''}" class="px-2 py-1 rounded border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-900 text-xs text-slate-900 dark:text-white outline-none focus:ring-1 focus:ring-blue-500">
                        <button onclick="saveEdit(${idx})" class="text-emerald-500 hover:text-emerald-600 font-bold px-1" title="Save">✔</button>
                        <button onclick="cancelEdit()" class="text-slate-400 hover:text-slate-500 font-bold px-1" title="Cancel">✕</button>
                    `;
                } else {
                    // View Mode UI
                    let dueDateHtml = '';
                    if (t.due) {
                        const dateObj = new Date(t.due);
                        const dateStr = dateObj.toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
                        dueDateHtml = `<span class="text-[10px] text-slate-400 dark:text-slate-500 border border-slate-200 dark:border-slate-700 rounded px-1.5 py-0.5 whitespace-nowrap flex items-center gap-1">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" />
                            </svg>
                            ${dateStr}
                        </span>`;
                    }

                    row.innerHTML = `
                        <button onclick="toggleTodoCompleted(${idx})" class="w-4 h-4 rounded border flex items-center justify-center text-[10px] ${t.completed ? 'bg-emerald-500 border-emerald-500 text-white' : 'border-slate-300 dark:border-slate-600 text-transparent'}">
                            ✓
                        </button>
                        <div class="flex-1 text-xs sm:text-sm ${t.completed ? 'line-through text-slate-400 dark:text-slate-500' : ''} flex items-center flex-wrap gap-2">
                            <span>${t.text}</span>
                            ${dueDateHtml}
                        </div>
                        <button onclick="startEdit(${idx})" class="text-slate-300 hover:text-blue-500 transition text-xs mr-1" title="Edit">✎</button>
                        <button onclick="deleteTodo(${idx})" class="text-slate-300 hover:text-rose-500 transition text-xs" title="Delete">✕</button>
                    `;
                }
                listEl.appendChild(row);
            });

            const remaining = todos.filter(t => !t.completed).length;
            const plural = todos.length === 1 ? 'task' : 'tasks';
            countEl.innerText = `${todos.length} ${plural} (${remaining} left)`;
        }

        function addTodo() {
            const input = document.getElementById('todo-input');
            const dateInput = document.getElementById('todo-due-date');
            if (!input) return;
            const text = input.value.trim();
            if (!text) return;

            let due = null;
            if (dateInput && dateInput.value) {
                // Store as YYYY-MM-DD string locally or just invoke date string
                due = dateInput.value;
            }

            const todo = { text, completed: false, googleTaskId: null, due: due };
            todos.unshift(todo);
            input.value = '';
            if (dateInput) dateInput.value = ''; // Reset date picker
            saveLocalTodos();
            renderTodos();

            // If Google Tasks is ready and signed in, also create remotely
            if (tasksClientInitialized && tasksSignedIn && typeof gapi !== 'undefined' && gapi.client && gapi.client.tasks) {
                createGoogleTaskForTodo(todo);
            }
        }

        function toggleTodoCompleted(idx) {
            if (idx < 0 || idx >= todos.length) return;
            const todo = todos[idx];
            todo.completed = !todo.completed;
            saveLocalTodos();
            renderTodos();

            if (tasksClientInitialized && tasksSignedIn && todo.googleTaskId && typeof gapi !== 'undefined' && gapi.client && gapi.client.tasks) {
                updateGoogleTaskCompletion(todo.googleTaskId, todo.completed);
            }
        }

        function deleteTodo(idx) {
            if (idx < 0 || idx >= todos.length) return;
            const todo = todos[idx];
            todos.splice(idx, 1);
            saveLocalTodos();
            renderTodos();

            if (tasksClientInitialized && tasksSignedIn && todo.googleTaskId && typeof gapi !== 'undefined' && gapi.client && gapi.client.tasks) {
                deleteGoogleTask(todo.googleTaskId);
            }
        }

        function startEdit(idx) {
            editingTodoIndex = idx;
            renderTodos();

            // Focus the text input
            setTimeout(() => {
                const input = document.getElementById(`edit-todo-text-${idx}`);
                if (input) input.focus();
            }, 50);
        }

        function cancelEdit() {
            editingTodoIndex = null;
            renderTodos();
        }

        function saveEdit(idx) {
            const textInput = document.getElementById(`edit-todo-text-${idx}`);
            const dateInput = document.getElementById(`edit-todo-date-${idx}`);
            if (!textInput) return;

            const newText = textInput.value.trim();
            if (!newText) {
                alert("Task cannot be empty.");
                return;
            }

            const newDue = dateInput && dateInput.value ? dateInput.value : null;
            const todo = todos[idx];

            todo.text = newText;
            todo.due = newDue;

            editingTodoIndex = null;
            saveLocalTodos();
            renderTodos();

            if (tasksClientInitialized && tasksSignedIn && todo.googleTaskId && typeof gapi !== 'undefined' && gapi.client && gapi.client.tasks) {
                updateGoogleTask(todo);
            }
        }

        function clearCompletedTodos() {
            const remaining = todos.filter(t => !t.completed);
            const removed = todos.length - remaining.length;
            if (!removed) return;
            todos = remaining;
            saveLocalTodos();
            renderTodos();
        }

        function updateTasksStatus(message, tone = 'neutral') {
            const statusEl = document.getElementById('tasks-status');
            if (!statusEl) return;
            statusEl.innerText = message;
            statusEl.classList.remove('text-amber-500', 'dark:text-amber-300', 'text-emerald-500', 'dark:text-emerald-300', 'text-rose-500', 'dark:text-rose-300');

            if (tone === 'warning') {
                statusEl.classList.add('text-amber-500', 'dark:text-amber-300');
            } else if (tone === 'success') {
                statusEl.classList.add('text-emerald-500', 'dark:text-emerald-300');
            } else if (tone === 'error') {
                statusEl.classList.add('text-rose-500', 'dark:text-rose-300');
            } else {
                statusEl.classList.add('text-amber-500', 'dark:text-amber-300');
            }
        }

        function updateTasksAuthUI() {
            const btn = document.getElementById('tasks-connect-btn');
            if (!btn) return;
            if (tasksSignedIn) {
                btn.innerText = 'Disconnect Tasks';
                btn.classList.remove('bg-blue-50', 'dark:bg-blue-900/30', 'text-blue-700', 'dark:text-blue-300');
                btn.classList.add('bg-slate-100', 'dark:bg-slate-800', 'text-slate-700', 'dark:text-slate-200');
                updateTasksStatus('Synced with your default Google Tasks list.', 'success');
            } else {
                btn.innerText = 'Connect Google Tasks';
                btn.classList.add('bg-blue-50', 'dark:bg-blue-900/30', 'text-blue-700', 'dark:text-blue-300');
                btn.classList.remove('bg-slate-100', 'dark:bg-slate-800', 'text-slate-700', 'dark:text-slate-200');
                updateTasksStatus('Google Tasks not connected. You can still add local to‑dos (not synced).', 'warning');
            }
        }

        function handleTasksAuthClick() {
            if (!tokenClient) {
                alert('Google Tasks client is still loading. Please try again in a moment.');
                return;
            }

            if (tasksSignedIn) {
                // GIS doesn't have a direct "signOut" method like gapi.auth2.
                // We simply clear our local state and the access token.
                // To truly revoke, you'd allow the user to revoke permissions, but for this app, 
                // clearing the session state is usually sufficient for "disconnect".
                const token = gapi.client.getToken();
                if (token !== null) {
                    google.accounts.oauth2.revoke(token.access_token, () => {
                        console.log('Token revoked.');
                    });
                    gapi.client.setToken('');
                }
                tasksSignedIn = false;
                accessToken = null;
                localStorage.removeItem('portal_tasks_token');
                localStorage.removeItem('portal_tasks_token_expiry');
                updateTasksAuthUI();
                updateTasksStatus('Disconnected from Google Tasks.', 'neutral');
            } else {
                if (gapi.client.getToken() === null) {
                    // Prompt the user to select a Google Account and ask for consent to share their data
                    // when establishing a new session.
                    tokenClient.requestAccessToken({ prompt: 'consent' });
                } else {
                    // Skip display of account chooser and consent dialog for an existing session.
                    tokenClient.requestAccessToken({ prompt: '' });
                }
            }
        }

        function restoreTasksSession() {
            const storedToken = localStorage.getItem('portal_tasks_token');
            const storedExpiry = localStorage.getItem('portal_tasks_token_expiry');

            if (storedToken && storedExpiry) {
                if (Date.now() < parseInt(storedExpiry)) {
                    gapi.client.setToken({ access_token: storedToken });
                    tasksSignedIn = true;
                    accessToken = storedToken;
                    updateTasksAuthUI();
                    fetchGoogleTasksIntoTodos();
                    console.log('Restored Google Tasks session from storage.');
                } else {
                    console.log('Stored token expired.');
                    localStorage.removeItem('portal_tasks_token');
                    localStorage.removeItem('portal_tasks_token_expiry');
                }
            }
        }

        async function initializeGoogleTasksClient() {
            // If the developer hasn't configured the keys yet, keep everything local-only.
            if (TASKS_CLIENT_ID.startsWith('REPLACE_') || TASKS_API_KEY.startsWith('REPLACE_')) {
                console.info('Google Tasks keys not configured; to‑dos will remain local-only.');
                return;
            }

            const start = Date.now();
            const maxWait = 5000;
            const waitForGapi = async () => {
                while (typeof gapi === 'undefined' && Date.now() - start < maxWait) {
                    await new Promise(r => setTimeout(r, 200));
                }
            };

            await waitForGapi();
            if (typeof gapi === 'undefined') {
                console.warn('gapi not available; Google Tasks integration disabled.');
                return;
            }

            gapi.load('client', async () => {
                try {
                    await gapi.client.init({
                        apiKey: TASKS_API_KEY,
                        discoveryDocs: TASKS_DISCOVERY_DOCS,
                    });

                    tasksClientInitialized = true;

                    // Initialize the Token Client
                    tokenClient = google.accounts.oauth2.initTokenClient({
                        client_id: TASKS_CLIENT_ID,
                        scope: TASKS_SCOPES,
                        callback: (tokenResponse) => {
                            if (tokenResponse && tokenResponse.access_token) {
                                tasksSignedIn = true;
                                accessToken = tokenResponse.access_token;

                                // Save token (expires_in is usually 3599 seconds)
                                const expiresIn = tokenResponse.expires_in || 3599;
                                const expiryTime = Date.now() + (expiresIn * 1000);
                                localStorage.setItem('portal_tasks_token', accessToken);
                                localStorage.setItem('portal_tasks_token_expiry', expiryTime);

                                updateTasksAuthUI();
                                fetchGoogleTasksIntoTodos();
                            }
                        },
                    });

                    restoreTasksSession();
                    updateTasksAuthUI();
                } catch (e) {
                    console.error('Failed to initialize Google Tasks client', e);
                    updateTasksStatus('Google Tasks setup failed; using local to‑dos only.', 'error');
                }
            });
        }

        async function fetchGoogleTasksIntoTodos() {
            if (!tasksClientInitialized || !tasksSignedIn || !gapi.client || !gapi.client.tasks) return;
            try {
                const response = await gapi.client.tasks.tasks.list({
                    tasklist: '@default',
                    showCompleted: true,
                    maxResults: 50
                });
                const items = response.result.items || [];

                // Merge remote tasks into local list by text label
                const byText = new Map();
                todos.forEach(t => {
                    byText.set(t.text, t);
                });

                items.forEach(item => {
                    const text = item.title || '';
                    if (!text) return;
                    const completed = typeof item.status === 'string' && item.status === 'completed'; // status is 'needsAction' or 'completed'

                    // Parse due date if present (RFC 3339 timestamp)
                    let due = null;
                    if (item.due) {
                        // Google Tasks returns a full timestamp string like "2023-10-26T00:00:00.000Z"
                        // We just want YYYY-MM-DD for our local logic/input
                        due = item.due.split('T')[0];
                    }

                    const existing = byText.get(text);
                    if (existing) {
                        existing.completed = completed;
                        existing.googleTaskId = item.id;
                        if (due) existing.due = due;
                    } else {
                        todos.push({
                            text,
                            completed,
                            googleTaskId: item.id,
                            due: due
                        });
                    }
                });

                saveLocalTodos();
                renderTodos();
                updateTasksStatus('Synced with Google Tasks (@default list).', 'success');
            } catch (e) {
                console.error('Failed to fetch Google Tasks', e);
                updateTasksStatus('Could not load Google Tasks; working from local list only.', 'error');
            }
        }

        async function createGoogleTaskForTodo(todo) {
            try {
                const res = await gapi.client.tasks.tasks.insert({
                    tasklist: '@default',
                    resource: {
                        title: todo.text,
                        status: todo.completed ? 'completed' : 'needsAction',
                        due: todo.due ? new Date(todo.due).toISOString() : undefined
                    }
                });
                if (res && res.result && res.result.id) {
                    todo.googleTaskId = res.result.id;
                    saveLocalTodos();
                }
            } catch (e) {
                console.error('Failed to create Google Task', e);
            }
        }

        async function updateGoogleTaskCompletion(taskId, completed) {
            try {
                const res = await gapi.client.tasks.tasks.get({
                    tasklist: '@default',
                    task: taskId
                });
                const task = res.result;
                task.status = completed ? 'completed' : 'needsAction';
                if (completed) {
                    task.completed = new Date().toISOString();
                } else {
                    task.completed = null;
                }
                await gapi.client.tasks.tasks.update({
                    tasklist: '@default',
                    task: taskId,
                    resource: task
                });
            } catch (e) {
                console.error('Failed to update Google Task completion', e);
            }
        }

        async function deleteGoogleTask(taskId) {
            try {
                await gapi.client.tasks.tasks.delete({
                    tasklist: '@default',
                    task: taskId
                });
            } catch (e) {
                console.error('Failed to delete Google Task', e);
            }
        }

        async function updateGoogleTask(todo) {
            try {
                // First get existing task to preserve other fields if needed, 
                // but mainly we just overwrite title and due date.
                const res = await gapi.client.tasks.tasks.get({
                    tasklist: '@default',
                    task: todo.googleTaskId
                });
                const task = res.result;

                task.title = todo.text;
                task.due = todo.due ? new Date(todo.due).toISOString() : null; // Parsing 'YYYY-MM-DD' creates a UTC midnight date, which is what we want for full-day tasks usually

                await gapi.client.tasks.tasks.update({
                    tasklist: '@default',
                    task: todo.googleTaskId,
                    resource: task
                });
            } catch (e) {
                console.error('Failed to update Google Task', e);
            }
        }

        // --- Rendering Workspace ---
        function renderSectionTabs(sections) {
            const container = document.getElementById('section-tabs');
            if (!container) return;
            container.innerHTML = '';
            sections.forEach(s => {
                const btn = document.createElement('button');
                btn.className = `px-4 py-2 rounded-xl text-xs font-bold whitespace-nowrap border border-transparent transition-all duration-300 uppercase tracking-wide`;
                btn.id = `tab-${s.replace(/\s/g, '-')}`;
                btn.innerText = s;
                btn.onclick = () => loadSection(s);
                container.appendChild(btn);
            });
        }

        function loadSection(sName) {
            activeSection = sName;
            document.querySelectorAll('#section-tabs button').forEach(b => {
                b.classList.remove('bg-white', 'dark:bg-slate-800', 'text-indigo-600', 'dark:text-indigo-400', 'border-slate-200', 'dark:border-slate-700', 'shadow-md', 'scale-105');
                b.classList.add('text-slate-500', 'dark:text-slate-400', 'hover:bg-slate-100', 'dark:hover:bg-slate-800/50');
            });
            const activeTab = document.getElementById(`tab-${sName.replace(/\s/g, '-')}`);
            if (activeTab) {
                activeTab.classList.add('bg-white', 'dark:bg-slate-800', 'text-indigo-600', 'dark:text-indigo-400', 'border-slate-200', 'dark:border-slate-700', 'shadow-md', 'scale-105');
                activeTab.classList.remove('text-slate-500', 'dark:text-slate-400', 'hover:bg-slate-100', 'dark:hover:bg-slate-800/50');
            }

            renderQuestions();
        }

        function renderQuestions() {
            try {
                const container = document.getElementById('question-grid');
                if (!container) return;
                container.innerHTML = '';
                const test = library[activeTestId];
                const section = test.key[activeSection];
                const progress = test.progress[activeSection] || {};

                const isAnyFilterActive = filters.wrong || filters.unattempted || filters.marked || filters.starred;

                section.answers.forEach((ans, idx) => {
                    const prog = progress[idx] || { userAns: section.type === 'multi' ? [] : "", submitted: false, marked: false, starred: false };

                    if (isAnyFilterActive) {
                        let match = false;
                        if (filters.wrong && prog.submitted && !prog.correct) match = true;
                        if (filters.unattempted && !prog.submitted) match = true;
                        if (filters.marked && prog.marked) match = true;
                        if (filters.starred && prog.starred) match = true;
                        if (!match) return;
                    }

                    const card = document.createElement('div');
                    // Cleaner card style
                    card.className = `glass p-6 rounded-3xl border transition-all duration-300 relative ${prog.marked ? 'marked-tint' : ''} ${prog.starred ? 'starred-glow' : ''} ${prog.submitted ? 'border-slate-200/50 dark:border-slate-700/50' : 'border-slate-100 dark:border-slate-800'}`;

                    if (prog.submitted) {
                        if (prog.correct) {
                            card.classList.add('bg-emerald-50/30', 'dark:bg-emerald-900/10', 'border-emerald-200/50', 'dark:border-emerald-900/30');
                        } else {
                            card.classList.add('bg-rose-50/30', 'dark:bg-rose-900/10', 'border-rose-200/50', 'dark:border-rose-900/30');
                        }
                    }

                    const qHeader = `
                        <div class="flex justify-between items-start mb-6">
                            <span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-slate-100 dark:bg-slate-800 text-xs font-bold text-slate-500 dark:text-slate-400 shadow-inner">
                                ${idx + 1}
                            </span>
                            <div class="flex gap-2">
                                <button onclick="toggleStar(${idx})" class="p-1.5 rounded-full transition ${prog.starred ? 'text-amber-500 bg-amber-50 dark:bg-amber-900/30 shadow-sm' : 'text-slate-300 dark:text-slate-600 hover:text-amber-400 hover:bg-slate-100 dark:hover:bg-slate-800'}">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                        <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                                    </svg>
                                </button>
                                <button onclick="toggleMark(${idx})" class="p-1.5 rounded-full transition ${prog.marked ? 'text-indigo-600 dark:text-indigo-400 bg-indigo-100 dark:bg-indigo-900/30 shadow-sm' : 'text-slate-300 dark:text-slate-600 hover:text-indigo-500 hover:bg-slate-100 dark:hover:bg-slate-800'}">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                        <path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                    `;

                    let inputHtml = '';
                    if (section.type === 'single' || (activeSection === "Section G (Match)" && idx >= 6)) {
                        inputHtml = `<div class="grid grid-cols-4 gap-3 mb-6">` + ['A', 'B', 'C', 'D'].map(o => `
                            <button onclick="selectSingle(${idx}, '${o}')" ${prog.submitted ? 'disabled' : ''} 
                                class="aspect-square rounded-2xl font-bold transition-all duration-200 flex items-center justify-center text-lg ${prog.userAns === o ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-500/30 scale-105 border-transparent' : 'bg-slate-100 dark:bg-slate-800/80 text-slate-600 dark:text-slate-300 border border-slate-200 dark:border-slate-700 hover:bg-slate-200 dark:hover:bg-slate-700 hover:border-slate-300 dark:hover:border-slate-600 shadow-sm'}">
                                ${o}
                            </button>
                        `).join('') + `</div>`;
                    } else if (section.type === 'multi') {
                        inputHtml = `<div class="grid grid-cols-4 gap-3 mb-6">` + ['A', 'B', 'C', 'D'].map(o => `
                            <button onclick="selectMulti(${idx}, '${o}')" ${prog.submitted ? 'disabled' : ''} 
                                class="aspect-square rounded-2xl font-bold transition-all duration-200 flex items-center justify-center text-lg ${prog.userAns.includes(o) ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-500/30 scale-105 border-transparent' : 'bg-slate-100 dark:bg-slate-800/80 text-slate-600 dark:text-slate-300 border border-slate-200 dark:border-slate-700 hover:bg-slate-200 dark:hover:bg-slate-700 hover:border-slate-300 dark:hover:border-slate-600 shadow-sm'}">
                                ${o}
                            </button>
                        `).join('') + `</div>`;
                    } else {
                        inputHtml = `<div class="relative mb-6">
                            <input type="text" placeholder="Type answer..." value="${prog.userAns || ''}" oninput="updateText(${idx}, this.value)" ${prog.submitted ? 'disabled' : ''} 
                            class="glass-input w-full px-5 py-4 rounded-xl text-lg text-center font-mono text-slate-900 dark:text-white outline-none disabled:opacity-60 placeholder:text-slate-300 dark:placeholder:text-slate-600">
                            ${!prog.submitted && prog.userAns ? `<button onclick="updateText(${idx}, ''); renderQuestions();" class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-300 hover:text-rose-500 transition p-1 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg></button>` : ''}
                            </div>`;
                    }

                    const submitBtn = `<button onclick="submitQuestion(${idx})" ${prog.submitted ? 'disabled' : ''} 
                        class="w-full py-3 rounded-xl font-bold text-sm tracking-wide transition-all duration-200 ${prog.submitted ? 'bg-slate-100 dark:bg-slate-800 text-slate-400 cursor-not-allowed' : 'bg-slate-900 dark:bg-white text-white dark:text-slate-900 hover:shadow-lg hover:-translate-y-0.5'}">
                        ${prog.submitted ? 'Submitted' : 'Submit Answer'}
                    </button>`;

                    const feedback = `<div class="mt-4 pt-4 border-t border-slate-100 dark:border-slate-800/50 ${prog.submitted ? 'block' : 'hidden'} animate-fade-in">
                        ${prog.correct ?
                            '<div class="flex items-center gap-2 text-emerald-600 dark:text-emerald-400 font-bold text-sm"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg> Correct Answer</div>' :
                            `<div class="flex items-start gap-2 text-rose-500 dark:text-rose-400 font-bold text-sm">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 shrink-0" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg>
                                <div>
                                    <span>Incorrect</span>
                                    <div class="text-slate-500 dark:text-slate-400 font-normal text-xs mt-1">Correct Answer: <span class="font-mono font-bold">${ans}</span></div>
                                </div>
                            </div>`
                        }
                    </div>`;

                    card.innerHTML = qHeader + inputHtml + submitBtn + feedback;
                    container.appendChild(card);
                });

                if (container.innerHTML === '') {
                    container.innerHTML = `<div class="col-span-full text-center py-20 text-slate-400 dark:text-slate-500 italic">No questions match the current filters.</div>`;
                }

            } catch (err) {
                console.error("Render Questions Error", err);
            }
        }

        // --- Interaction Logic ---
        function toggleMark(qIdx) {
            initSectionProgress();
            const prog = library[activeTestId].progress[activeSection][qIdx];
            prog.marked = !prog.marked;
            saveAndSync();
            renderQuestions();
        }

        function toggleStar(qIdx) {
            initSectionProgress();
            const prog = library[activeTestId].progress[activeSection][qIdx];
            prog.starred = !prog.starred;
            saveAndSync();
            renderQuestions();
        }

        function selectSingle(qIdx, val) {
            initSectionProgress();
            const currentAns = library[activeTestId].progress[activeSection][qIdx].userAns;
            library[activeTestId].progress[activeSection][qIdx].userAns = (currentAns === val) ? "" : val;
            renderQuestions();
        }

        function selectMulti(qIdx, val) {
            initSectionProgress();
            let current = library[activeTestId].progress[activeSection][qIdx].userAns;
            if (!Array.isArray(current)) current = [];
            if (current.includes(val)) current = current.filter(x => x !== val);
            else current.push(val);
            library[activeTestId].progress[activeSection][qIdx].userAns = current;
            renderQuestions();
        }

        function updateText(qIdx, val) {
            initSectionProgress();
            library[activeTestId].progress[activeSection][qIdx].userAns = val;
        }

        function initSectionProgress() {
            if (!library[activeTestId].progress) {
                library[activeTestId].progress = {};
            }
            if (!library[activeTestId].progress[activeSection]) {
                library[activeTestId].progress[activeSection] = {};
            }
            const sectionAnswers = library[activeTestId].key[activeSection].answers;
            sectionAnswers.forEach((_, i) => {
                if (!library[activeTestId].progress[activeSection][i]) {
                    const type = library[activeTestId].key[activeSection].type;
                    library[activeTestId].progress[activeSection][i] = { userAns: type === 'multi' ? [] : "", submitted: false, marked: false, starred: false };
                }
            });
        }

        function submitQuestion(qIdx) {
            initSectionProgress();
            const q = library[activeTestId].progress[activeSection][qIdx];
            const actualAns = library[activeTestId].key[activeSection].answers[qIdx];

            const hasAns = Array.isArray(q.userAns) ? q.userAns.length > 0 : (q.userAns && q.userAns.toString().trim() !== "");
            if (!hasAns) {
                alert("Please select/enter an answer first.");
                return;
            }

            q.submitted = true;
            q.correct = compareAnswers(q.userAns, actualAns);
            saveAndSync();
            renderQuestions();
        }

        function submitAllAttempted() {
            if (!activeTestId || !activeSection) return;
            initSectionProgress();

            const test = library[activeTestId];
            const sectionKey = test.key[activeSection];
            const progress = test.progress[activeSection];
            let count = 0;

            sectionKey.answers.forEach((ans, idx) => {
                const q = progress[idx];
                if (q && !q.submitted) {
                    const hasAns = Array.isArray(q.userAns) ? q.userAns.length > 0 : (q.userAns && q.userAns.toString().trim() !== "");
                    if (hasAns) {
                        q.submitted = true;
                        q.correct = compareAnswers(q.userAns, ans);
                        count++;
                    }
                }
            });

            if (count > 0) {
                saveAndSync();
                renderQuestions();
            } else {
                alert("No new attempted questions to submit in this section.");
            }
        }

        // --- Library Export/Import ---
        function exportLibrary() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(library));
            const dlNode = document.createElement('a');
            dlNode.setAttribute("href", dataStr);
            dlNode.setAttribute("download", `study_portal_full_backup_${Date.now()}.json`);
            dlNode.click();
        }

        function exportSingleTest(id) {
            const test = library[id];
            if (!test) return;
            const singleTestData = { [id]: test };
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(singleTestData));
            const dlNode = document.createElement('a');
            dlNode.setAttribute("href", dataStr);
            dlNode.setAttribute("download", `${test.title.replace(/\s+/g, '_')}_backup.json`);
            dlNode.click();
        }

        function downloadOriginalKey(id) {
            const test = library[id];
            if (!test) return;
            const originalKey = test.key;
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(originalKey, null, 2));
            const dlNode = document.createElement('a');
            dlNode.setAttribute("href", dataStr);
            dlNode.setAttribute("download", `${test.title.replace(/\s+/g, '_')}_original_key.json`);
            dlNode.click();
        }

        function openKeyViewer(id) {
            const test = library[id];
            if (!test) return;
            const titleEl = document.getElementById('keyViewerTitle');
            const contentEl = document.getElementById('keyViewerContent');
            const downloadBtn = document.getElementById('downloadKeyBtn');

            titleEl.innerText = `Answer Key: ${test.title}`;
            contentEl.innerHTML = '';

            Object.keys(test.key).forEach(sectionName => {
                const section = test.key[sectionName];
                const sectionDiv = document.createElement('div');
                sectionDiv.className = 'bg-slate-50 dark:bg-slate-800/50 p-4 rounded-xl border border-slate-100 dark:border-slate-800';

                const sectionHeader = document.createElement('h4');
                sectionHeader.className = 'font-bold text-slate-700 dark:text-slate-300 mb-3 uppercase tracking-wider text-xs';
                sectionHeader.innerText = sectionName;
                sectionDiv.appendChild(sectionHeader);

                const grid = document.createElement('div');
                grid.className = 'grid grid-cols-2 sm:grid-cols-4 md:grid-cols-5 gap-3';

                section.answers.forEach((ans, idx) => {
                    const item = document.createElement('div');
                    item.className = 'text-[11px] flex flex-col items-center bg-white dark:bg-slate-800 p-2 rounded border border-slate-200 dark:border-slate-700';
                    item.innerHTML = `<span class="text-slate-400 dark:text-slate-500 font-bold mb-1">Q${idx + 1}</span> <span class="text-slate-800 dark:text-slate-200 font-black">${ans}</span>`;
                    grid.appendChild(item);
                });

                sectionDiv.appendChild(grid);
                contentEl.appendChild(sectionDiv);
            });

            downloadBtn.onclick = () => downloadOriginalKey(id);

            const modal = document.getElementById('keyViewerModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function importLibrary(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const imported = JSON.parse(e.target.result);
                    if (typeof imported !== 'object') throw new Error("Format error");
                    library = { ...library, ...imported };
                    saveAndSync();
                    renderLibrary();
                    alert("Library merged successfully.");
                } catch (err) { alert("Invalid backup file."); }
            };
            reader.readAsText(file);
        }

        // --- Reporting ---
        function showReport() {
            const test = library[activeTestId];
            if (!test) return;
            const content = document.getElementById('reportContent');
            content.innerHTML = '';

            let total = 0, totalCorrect = 0, totalAttempted = 0, totalIncorrect = 0;
            const sectionRows = [];

            Object.keys(test.key).forEach(s => {
                const sAns = test.key[s].answers;
                const sProg = test.progress ? (test.progress[s] || {}) : {};
                let sCorrect = 0, sAttempted = 0, sIncorrect = 0;

                sAns.forEach((_, idx) => {
                    const q = sProg[idx];
                    if (q && q.submitted) {
                        sAttempted++;
                        if (q.correct) sCorrect++;
                        else sIncorrect++;
                    }
                });

                total += sAns.length;
                totalCorrect += sCorrect;
                totalAttempted += sAttempted;
                totalIncorrect += sIncorrect;

                const row = document.createElement('div');
                row.className = 'bg-slate-50 dark:bg-slate-800/50 p-4 rounded-xl border border-slate-100 dark:border-slate-800';
                row.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-bold text-slate-700 dark:text-slate-300">${s}</span>
                        <span class="text-xs font-black px-2 py-1 bg-slate-200 dark:bg-slate-800 rounded uppercase tracking-tighter dark:text-slate-400">Section</span>
                    </div>
                    <div class="grid grid-cols-3 gap-2 text-center text-xs">
                        <div class="bg-blue-50 dark:bg-blue-900/20 p-2 rounded">
                            <div class="text-slate-400 dark:text-slate-500 font-medium mb-1">Attempted</div>
                            <div class="text-blue-600 dark:text-blue-400 font-bold">${sAttempted} / ${sAns.length}</div>
                        </div>
                        <div class="bg-emerald-50 dark:bg-emerald-900/20 p-2 rounded">
                            <div class="text-slate-400 dark:text-slate-500 font-medium mb-1">Correct</div>
                            <div class="text-emerald-600 dark:text-emerald-400 font-bold">${sCorrect}</div>
                        </div>
                        <div class="bg-rose-50 dark:bg-rose-900/20 p-2 rounded">
                            <div class="text-slate-400 dark:text-slate-500 font-medium mb-1">Incorrect</div>
                            <div class="text-rose-600 dark:text-rose-400 font-bold">${sIncorrect}</div>
                        </div>
                    </div>
                `;
                sectionRows.push(row);
            });

            const pct = total > 0 ? Math.round((totalCorrect / total) * 100) : 0;
            const summary = document.createElement('div');
            summary.className = 'bg-slate-900 dark:bg-black text-white rounded-2xl p-6 mb-6';
            summary.innerHTML = `
                <div class="flex flex-col md:flex-row justify-between items-center gap-6">
                    <div class="text-center md:text-left">
                        <h4 class="text-5xl font-black mb-1">${pct}%</h4>
                        <p class="text-slate-400 text-sm font-medium uppercase tracking-widest">Final Score</p>
                    </div>
                    <div class="h-px w-full md:h-12 md:w-px bg-slate-700 dark:bg-slate-800"></div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-8 flex-1 w-full text-center">
                        <div>
                            <div class="text-2xl font-bold">${totalAttempted}</div>
                            <div class="text-[10px] text-slate-400 uppercase font-bold tracking-widest">Attempted</div>
                        </div>
                        <div>
                            <div class="text-2xl font-bold text-emerald-400">${totalCorrect}</div>
                            <div class="text-[10px] text-slate-400 uppercase font-bold tracking-widest">Correct</div>
                        </div>
                        <div>
                            <div class="text-2xl font-bold text-rose-400">${totalIncorrect}</div>
                            <div class="text-[10px] text-slate-400 uppercase font-bold tracking-widest">Incorrect</div>
                        </div>
                        <div>
                            <div class="text-2xl font-bold text-blue-400 font-mono">${formatTime(test.timeSpent || 0)}</div>
                            <div class="text-[10px] text-slate-400 uppercase font-bold tracking-widest">Time Spent</div>
                        </div>
                    </div>
                </div>
                ${test.sessionGoal > 0 ? `
                <div class="mt-4 pt-4 border-t border-slate-700 dark:border-slate-800 flex justify-between items-center text-xs">
                    <span class="text-slate-400 font-bold uppercase tracking-widest">Session Goal Performance</span>
                    <span class="${totalAttempted >= test.sessionGoal ? 'text-emerald-400' : 'text-rose-400'} font-black">
                        ${totalAttempted} / ${test.sessionGoal} Questions Attempted
                    </span>
                </div>` : ''}
            `;

            content.appendChild(summary);
            const gridContainer = document.createElement('div');
            gridContainer.className = 'grid grid-cols-1 md:grid-cols-2 gap-4';
            sectionRows.forEach(row => gridContainer.appendChild(row));
            content.appendChild(gridContainer);

            const modal = document.getElementById('reportModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closeModal(id) {
            const modal = document.getElementById(id);
            if (modal) {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }
        }
    </script>
</body>

</html>
