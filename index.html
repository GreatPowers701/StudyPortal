<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Study Portal - Multi-Test Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDK -->
    <!-- Use compat builds (global `firebase`) so existing code works without module imports -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    <!-- Google Sign-In -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <!-- Google APIs Client (for Google Tasks) -->
    <script src="https://apis.google.com/js/api.js" async defer></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    animation: {
                        'bounce-short': 'bounce-short 0.5s ease-in-out 3',
                    },
                    keyframes: {
                        'bounce-short': {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
        }

        /* Softer "glass" for dark mode */
        .glass {
            @apply bg-white/95 dark:bg-slate-800/90 backdrop-blur-md;
        }

        .card-shadow {
            box-shadow: 0 4px 20px -2px rgba(15, 23, 42, 0.15);
        }

        /* Subtle, lighter scrollbars in dark mode */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            @apply bg-slate-100 dark:bg-slate-900;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            @apply bg-slate-300 dark:bg-slate-600/90 rounded-full;
        }

        html {
            scroll-behavior: smooth;
        }

        #autosave-indicator {
            transition: opacity 0.3s ease;
        }

        /* Mark for review tint */
        .marked-tint {
            @apply bg-blue-50/80 dark:bg-blue-900/10 border-blue-400 dark:border-blue-400 !important;
        }

        /* Starred indicator glow */
        .starred-glow {
            @apply border-amber-400 dark:border-amber-400 shadow-[0_0_15px_rgba(245, 158, 11, 0.25)] !important;
        }
    </style>
</head>

<body
    class="bg-slate-50 dark:bg-gradient-to-b dark:from-slate-900 dark:via-slate-900 dark:to-slate-950 min-h-screen text-slate-800 dark:text-slate-100 transition-colors duration-300">

    <!-- Autosave Indicator -->
    <div id="autosave-indicator"
        class="fixed bottom-4 right-4 bg-slate-900 dark:bg-slate-100 text-white dark:text-slate-900 text-[10px] px-3 py-1 rounded-full font-bold uppercase tracking-widest opacity-0 z-[100] pointer-events-none">
        Saved ✓
    </div>

    <div id="app" class="max-w-6xl mx-auto px-4 py-8">
        <!-- Navigation Header -->
        <header class="flex justify-between items-center mb-8">
            <div id="header-left" class="flex items-center gap-4">
                <h1 class="text-2xl font-bold text-slate-900 dark:text-white tracking-tight">Study Portal</h1>
            </div>
            <div id="header-right" class="flex items-center gap-2 flex-wrap justify-end w-full sm:w-auto">
                <!-- Version Badge -->
                <div
                    class="text-[9px] sm:text-[10px] text-slate-400 dark:text-slate-500 font-bold px-2 py-1 rounded-md bg-slate-100 dark:bg-slate-800 whitespace-nowrap uppercase tracking-widest">
                    v1.8</div>
                <!-- Auth Status -->
                <div id="auth-container" class="flex items-center gap-2 flex-wrap justify-end w-full sm:w-auto">
                    <div id="user-info"
                        class="hidden items-center gap-2 sm:gap-3 px-2 sm:px-4 py-1.5 sm:py-2 bg-slate-100 dark:bg-slate-800 rounded-lg order-last sm:order-none">
                        <img id="user-avatar" class="w-5 h-5 sm:w-6 sm:h-6 rounded-full" alt="User">
                        <span id="user-name"
                            class="text-xs sm:text-sm font-medium text-slate-600 dark:text-slate-300 hidden sm:inline"></span>
                        <button onclick="signOut()"
                            class="text-xs bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400 px-1.5 sm:px-2 py-0.5 sm:py-1 rounded font-bold hover:bg-red-200 dark:hover:bg-red-900/50 transition">Sign
                            Out</button>
                    </div>
                    <button id="google-signin-btn"
                        class="text-xs sm:text-sm bg-blue-600 text-white px-2.5 sm:px-4 py-1.5 sm:py-2 rounded-lg font-medium hover:bg-blue-700 transition whitespace-nowrap">Sign
                        in</button>
                </div>
                <!-- Theme Toggle -->
                <button onclick="toggleTheme()"
                    class="p-1.5 sm:p-2 rounded-lg bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-700 transition"
                    title="Toggle Theme">
                    <svg id="theme-icon-sun" xmlns="http://www.w3.org/2000/svg"
                        class="h-4 w-4 sm:h-5 sm:w-5 hidden dark:block" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364-6.364l-.707.707M6.343 17.657l-.707.707M16.243 16.243l.707.707M7.757 7.757l.707.707M12 8a4 4 0 100 8 4 4 0 000-8z" />
                    </svg>
                    <svg id="theme-icon-moon" xmlns="http://www.w3.org/2000/svg"
                        class="h-4 w-4 sm:h-5 sm:w-5 block dark:hidden" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                    </svg>
                </button>
                <button onclick="exportLibrary()"
                    class="text-xs sm:text-sm bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 px-2.5 sm:px-4 py-1.5 sm:py-2 rounded-lg font-medium hover:bg-slate-50 dark:hover:bg-slate-700 transition whitespace-nowrap">Export</button>
                <label
                    class="text-xs sm:text-sm bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 px-2.5 sm:px-4 py-1.5 sm:py-2 rounded-lg font-medium hover:bg-slate-50 dark:hover:bg-slate-700 transition cursor-pointer whitespace-nowrap">
                    Import <input type="file" id="importLibraryInput" class="hidden" onchange="importLibrary(event)">
                </label>
            </div>
        </header>

        <!-- View: Home Screen -->
        <main id="view-home" class="space-y-8">
            <!-- Top Row: Add Test + To-Do (stacked on mobile, side-by-side on larger screens) -->
            <section class="grid grid-cols-1 lg:grid-cols-2 gap-6 items-start">
                <!-- Upload Section -->
                <div
                    class="glass p-8 rounded-2xl border border-slate-200 dark:border-slate-800 card-shadow text-center">
                    <h2 class="text-lg font-semibold mb-2 dark:text-white">Add New Test</h2>
                    <p class="text-slate-500 dark:text-slate-400 text-sm mb-6">Upload a JSON answer key to create a new
                        practice session.</p>
                    <div class="flex flex-col sm:flex-row items-center justify-center gap-4 mb-4">
                        <div class="w-full sm:w-64 space-y-2">
                            <input type="text" id="newTestTitle" placeholder="Test Title (e.g. Physics Mock 1)"
                                class="w-full px-4 py-2 rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 text-slate-900 dark:text-white outline-none focus:ring-2 focus:ring-blue-500 mb-1">
                            <input type="text" id="newTestSubject" placeholder="Subject (optional, e.g. Physics)"
                                class="w-full px-4 py-2 rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 text-slate-900 dark:text-white outline-none focus:ring-2 focus:ring-blue-500 text-xs">
                        </div>
                        <input type="file" id="newTestFile" accept=".json" class="hidden">
                        <button onclick="document.getElementById('newTestFile').click()"
                            class="bg-blue-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-blue-700 transition">Upload
                            JSON</button>
                    </div>
                    <div class="pt-4 border-t border-slate-100 dark:border-slate-800">
                        <p class="text-xs text-slate-400 mb-3 uppercase tracking-widest font-bold">Need to extract
                            answers from images?</p>
                        <button onclick="copyExtractionPrompt()"
                            class="text-xs bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 border border-slate-200 dark:border-slate-700 px-4 py-2 rounded-lg font-bold hover:bg-slate-200 dark:hover:bg-slate-700 transition flex items-center gap-2 mx-auto">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3" />
                            </svg>
                            Copy Extraction Prompt
                        </button>
                    </div>
                </div>

                <!-- To-Do List Section (Google Tasks) -->
                <div class="glass p-8 rounded-2xl border border-slate-200 dark:border-slate-800 card-shadow">
                    <div class="flex items-center justify-between gap-3 mb-3">
                        <h2 class="text-lg font-semibold dark:text-white">Study To‑Do List</h2>
                        <button id="tasks-connect-btn" onclick="handleTasksAuthClick()"
                            class="text-xs bg-blue-50 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 border border-blue-200 dark:border-blue-800 px-3 py-1.5 rounded-lg font-semibold hover:bg-blue-100 dark:hover:bg-blue-900/50 transition whitespace-nowrap">
                            Connect Google Tasks
                        </button>
                    </div>
                    <p class="text-slate-500 dark:text-slate-400 text-xs mb-4">
                        Keep a quick list of study to‑dos. When connected, this syncs with your default Google Tasks
                        list.
                    </p>

                    <div id="tasks-status" class="text-[11px] mb-3 text-amber-500 dark:text-amber-300">
                        Google Tasks not connected. You can still add local to‑dos (not synced).
                    </div>

                    <!-- Add To-Do -->
                    <div class="flex flex-col sm:flex-row gap-2 mb-4">
                        <input id="todo-input" type="text" placeholder="New task (e.g. Review Physics Mock 1 mistakes)"
                            class="flex-1 px-3 py-2 rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 text-xs text-slate-900 dark:text-white outline-none focus:ring-2 focus:ring-blue-500">
                        <input id="todo-due-date" type="date"
                            class="px-3 py-2 rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 text-xs text-slate-900 dark:text-white outline-none focus:ring-2 focus:ring-blue-500">
                        <button onclick="addTodo()"
                            class="bg-slate-900 dark:bg-white text-white dark:text-slate-900 px-4 py-2 rounded-lg text-xs font-semibold hover:bg-slate-800 dark:hover:bg-slate-100 transition whitespace-nowrap">
                            Add
                        </button>
                    </div>

                    <!-- Task List -->
                    <div id="todo-list"
                        class="max-h-64 overflow-y-auto custom-scrollbar space-y-2 text-sm text-slate-700 dark:text-slate-200">
                        <!-- Tasks rendered here -->
                    </div>

                    <div class="mt-4 flex items-center justify-between text-[11px] text-slate-400 dark:text-slate-500">
                        <span id="todo-count">0 tasks</span>
                        <button onclick="clearCompletedTodos()" class="hover:text-rose-500 transition">Clear
                            completed</button>
                    </div>
                </div>
            </section>

            <!-- Library Grid -->
            <section>
                <h2 class="text-xl font-bold mb-6 flex items-center gap-2 dark:text-white">
                    My Tests <span id="test-count"
                        class="bg-slate-200 dark:bg-slate-800 text-slate-600 dark:text-slate-400 text-xs px-2 py-1 rounded-full">0</span>
                </h2>
                <div id="test-library" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Cards injected here -->
                </div>
            </section>
        </main>

        <!-- View: Test Workspace -->
        <main id="view-test" class="hidden space-y-6">
            <div class="flex flex-wrap justify-between items-center gap-4 mb-4">
                <button onclick="goHome()"
                    class="flex items-center gap-2 text-slate-500 dark:text-slate-400 hover:text-slate-900 dark:hover:text-white font-medium transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd"
                            d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z"
                            clip-rule="evenodd" />
                    </svg>
                    Back to Library
                </button>
                <div class="flex items-center gap-4">
                    <!-- Goals and Timer Info -->
                    <div id="timer-display-area" class="flex items-center gap-3">
                        <div id="active-goal-stats"
                            class="hidden items-center gap-2 bg-slate-900 dark:bg-slate-100 text-white dark:text-slate-900 px-3 py-1.5 rounded-lg text-xs font-bold uppercase tracking-wider">
                            Goal: <span id="display-goal-num">0</span> Qs
                        </div>
                        <div
                            class="flex items-center bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg overflow-hidden h-9">
                            <div id="timer-box"
                                class="flex items-center gap-2 px-3 py-1.5 text-slate-600 dark:text-slate-300 font-mono text-sm cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700 transition border-r border-slate-100 dark:border-slate-700"
                                onclick="openTimerSettings()" title="Timer Settings">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                                    stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                <span id="test-timer">00:00:00</span>
                            </div>
                            <button id="timer-toggle-btn" onclick="toggleTimer()"
                                class="px-3 hover:bg-slate-50 dark:hover:bg-slate-700 transition text-slate-600 dark:text-slate-400"
                                title="Start/Stop Timer">
                                <svg id="timer-play-icon" xmlns="http://www.w3.org/2000/svg" class="h-4 w-4"
                                    viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd"
                                        d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z"
                                        clip-rule="evenodd" />
                                </svg>
                                <svg id="timer-stop-icon" xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 hidden"
                                    viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd"
                                        d="M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a1 1 0 00-1 1v4a1 1 0 001 1h4a1 1 0 001-1V8a1 1 0 00-1-1H8z"
                                        clip-rule="evenodd" />
                                </svg>
                            </button>
                        </div>
                    </div>
                    <button onclick="openKeyViewer(activeTestId)"
                        class="text-sm bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 px-4 py-2 rounded-lg font-medium hover:bg-slate-50 dark:hover:bg-slate-700 transition dark:text-slate-200"
                        title="View answer key">Original Key</button>
                    <button onclick="exportSingleTest(activeTestId)"
                        class="text-sm bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 px-4 py-2 rounded-lg font-medium hover:bg-slate-50 dark:hover:bg-slate-700 transition dark:text-slate-200">Export</button>
                    <button onclick="showReport()"
                        class="bg-emerald-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-emerald-700 transition">Report</button>
                </div>
            </div>

            <div id="test-workspace-header" class="space-y-4">
                <h2 id="active-test-title" class="text-3xl font-bold text-slate-900 dark:text-white"></h2>

                <!-- Sticky Top Bar for Sections, Submit, and Filters -->
                <div
                    class="sticky top-0 z-20 bg-slate-50/95 dark:bg-slate-900/90 backdrop-blur-md -mx-4 px-4 py-4 border-b border-slate-200 dark:border-slate-800 space-y-3">
                    <div class="flex items-center justify-between flex-wrap gap-4">
                        <div class="flex gap-2 overflow-x-auto pb-2 custom-scrollbar flex-1" id="section-tabs"></div>
                        <button onclick="submitAllAttempted()"
                            class="text-sm bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 border border-blue-200 dark:border-blue-800 px-4 py-2 rounded-lg font-bold hover:bg-blue-100 dark:hover:bg-blue-900/50 transition whitespace-nowrap">
                            Submit All Attempted (Section)
                        </button>
                    </div>

                    <!-- Sorting/Filters Row -->
                    <div class="flex flex-wrap items-center gap-3">
                        <span
                            class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mr-2">Filters:</span>
                        <button onclick="toggleFilter('wrong')" id="filter-wrong"
                            class="text-xs px-3 py-1.5 rounded-full border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 text-slate-800 dark:text-slate-300 font-semibold transition hover:bg-slate-100 dark:hover:bg-slate-700 active:scale-95">
                            Show Wrong
                        </button>
                        <button onclick="toggleFilter('unattempted')" id="filter-unattempted"
                            class="text-xs px-3 py-1.5 rounded-full border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 text-slate-800 dark:text-slate-300 font-semibold transition hover:bg-slate-100 dark:hover:bg-slate-700 active:scale-95">
                            Show Unattempted
                        </button>
                        <button onclick="toggleFilter('marked')" id="filter-marked"
                            class="text-xs px-3 py-1.5 rounded-full border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 text-slate-800 dark:text-slate-300 font-semibold transition hover:bg-slate-100 dark:hover:bg-slate-700 active:scale-95">
                            Show Marked
                        </button>
                        <button onclick="toggleFilter('starred')" id="filter-starred"
                            class="text-xs px-3 py-1.5 rounded-full border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 text-slate-800 dark:text-slate-300 font-semibold transition hover:bg-slate-100 dark:hover:bg-slate-700 active:scale-95 flex items-center gap-1.5">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20"
                                fill="currentColor">
                                <path
                                    d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                            </svg>
                            Show Starred
                        </button>
                        <button onclick="clearFilters()" id="filter-clear"
                            class="hidden text-xs px-3 py-1.5 rounded-full text-rose-500 font-bold hover:bg-rose-50 dark:hover:bg-rose-900/20 transition">
                            Clear Filters
                        </button>
                    </div>
                </div>
            </div>

            <div id="question-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </main>
    </div>

    <!-- Modals -->
    <!-- Report Modal -->
    <div id="reportModal"
        class="fixed inset-0 bg-slate-900/50 dark:bg-black/70 hidden items-center justify-center z-50 p-4">
        <div class="bg-white dark:bg-slate-900 rounded-2xl max-w-3xl w-full p-8 relative max-h-[90vh] overflow-y-auto">
            <button onclick="closeModal('reportModal')"
                class="absolute top-4 right-4 text-slate-400 hover:text-slate-600 transition">✕</button>
            <h3 class="text-2xl font-bold mb-6 text-slate-900 dark:text-white">Performance Summary</h3>
            <div id="reportContent" class="space-y-6"></div>
            <button onclick="closeModal('reportModal')"
                class="mt-8 w-full bg-slate-900 dark:bg-white text-white dark:text-slate-900 py-3 rounded-xl font-bold">Done</button>
        </div>
    </div>

    <!-- Answer Key Viewer Modal -->
    <div id="keyViewerModal"
        class="fixed inset-0 bg-slate-900/50 dark:bg-black/70 hidden items-center justify-center z-50 p-4">
        <div class="bg-white dark:bg-slate-900 rounded-2xl max-w-3xl w-full p-8 relative max-h-[90vh] flex flex-col">
            <button onclick="closeModal('keyViewerModal')"
                class="absolute top-4 right-4 text-slate-400 hover:text-slate-600 transition">✕</button>
            <h3 id="keyViewerTitle" class="text-2xl font-bold mb-6 text-slate-900 dark:text-white">Answer Key</h3>

            <div id="keyViewerContent" class="space-y-6 overflow-y-auto custom-scrollbar pr-2 flex-1">
                <!-- Answer key rows injected here -->
            </div>

            <div class="flex gap-3 mt-8">
                <button onclick="closeModal('keyViewerModal')"
                    class="flex-1 bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-400 py-3 rounded-xl font-bold">Close</button>
                <button id="downloadKeyBtn"
                    class="flex-1 bg-blue-600 text-white py-3 rounded-xl font-bold flex items-center justify-center gap-2 shadow-lg shadow-blue-500/20">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                    </svg>
                    Download JSON
                </button>
            </div>
        </div>
    </div>

    <!-- Timer/Goal Settings Modal -->
    <div id="timerSettingsModal"
        class="fixed inset-0 bg-slate-900/50 dark:bg-black/70 hidden items-center justify-center z-50 p-4">
        <div class="bg-white dark:bg-slate-900 rounded-2xl max-w-md w-full p-8 relative">
            <h3 class="text-xl font-bold mb-4 text-slate-900 dark:text-white">Session Settings</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-semibold text-slate-600 dark:text-slate-400 mb-1">Time Limit
                        (Minutes)</label>
                    <input type="number" id="input-timer-mins" placeholder="e.g. 30"
                        class="w-full px-4 py-2 rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 text-slate-900 dark:text-white focus:ring-2 focus:ring-blue-500 outline-none">
                    <p class="text-[10px] text-slate-400 mt-1">Set to 0 to use a simple count-up timer.</p>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-slate-600 dark:text-slate-400 mb-1">Question
                        Goal</label>
                    <input type="number" id="input-goal-num" placeholder="e.g. 20"
                        class="w-full px-4 py-2 rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 text-slate-900 dark:text-white focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
            </div>
            <div class="flex gap-3 mt-8">
                <button onclick="closeModal('timerSettingsModal')"
                    class="flex-1 bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-400 py-2 rounded-lg font-bold">Cancel</button>
                <button onclick="saveTimerSettings()"
                    class="flex-1 bg-blue-600 text-white py-2 rounded-lg font-bold shadow-lg shadow-blue-500/20">Save
                    Settings</button>
            </div>
        </div>
    </div>

    <!-- Edit Test Modal -->
    <div id="editTestModal"
        class="fixed inset-0 bg-slate-900/50 dark:bg-black/70 hidden items-center justify-center z-50 p-4">
        <div class="bg-white dark:bg-slate-900 rounded-2xl max-w-md w-full p-8 relative">
            <button onclick="closeModal('editTestModal')"
                class="absolute top-4 right-4 text-slate-400 hover:text-slate-600 transition">✕</button>
            <h3 class="text-xl font-bold mb-4 text-slate-900 dark:text-white">Edit Test</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-semibold text-slate-600 dark:text-slate-400 mb-1">Title</label>
                    <input type="text" id="edit-test-title"
                        class="w-full px-4 py-2 rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 text-slate-900 dark:text-white focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-slate-600 dark:text-slate-400 mb-1">Subject</label>
                    <input type="text" id="edit-test-subject" placeholder="e.g. Physics, Chemistry"
                        class="w-full px-4 py-2 rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 text-slate-900 dark:text-white focus:ring-2 focus:ring-blue-500 outline-none">
                    <p class="text-[10px] text-slate-400 mt-1">Leave blank to keep this test in the Uncategorised
                        section.</p>
                </div>
            </div>
            <div class="flex gap-3 mt-8">
                <button onclick="closeModal('editTestModal')"
                    class="flex-1 bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-400 py-2 rounded-lg font-bold">Cancel</button>
                <button onclick="saveTestEdits()"
                    class="flex-1 bg-blue-600 text-white py-2 rounded-lg font-bold shadow-lg shadow-blue-500/20">Save
                    Changes</button>
            </div>
        </div>
    </div>

    <!-- Timer End Notification -->
    <div id="timerEndModal"
        class="fixed inset-0 bg-slate-900/50 dark:bg-black/70 hidden items-center justify-center z-[60] p-4">
        <div
            class="bg-white dark:bg-slate-900 rounded-2xl max-sm w-full p-8 text-center shadow-2xl animate-bounce-short">
            <div
                class="w-16 h-16 bg-blue-100 dark:bg-blue-900/50 text-blue-600 dark:text-blue-400 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
            </div>
            <h3 class="text-2xl font-black text-slate-900 dark:text-white mb-2">Time's Up!</h3>
            <p class="text-slate-500 dark:text-slate-400 text-sm mb-6">Your set timer has ended. You can dismiss this
                and continue working on your test.</p>
            <button onclick="closeModal('timerEndModal')"
                class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold shadow-lg">Got it</button>
        </div>
    </div>

    <script>
        // --- Core State Management ---
        let library = {};
        let activeTestId = null;
        let activeSection = null;
        let timerInterval = null;
        let saveTimeout = null;
        let currentTheme = localStorage.getItem('portal_theme') || 'light';
        let currentUser = null;
        let isSyncing = false;
        let auth = null;
        let db = null;
        let editingTestId = null;

        // --- To-Do / Google Tasks State ---
        let todos = [];
        let editingTodoIndex = null; // Track which todo is being edited
        let tasksClientInitialized = false;
        let tasksSignedIn = false;
        let tokenClient;
        let accessToken = null;
        const TASKS_CLIENT_ID = '1068803170496-74g9qkb8851fbvamiduik6ik64opqu6e.apps.googleusercontent.com';
        const TASKS_API_KEY = 'AIzaSyAEw5jkjWOWj5yiBn-UB2GW-xSGZ6VBiKY';
        const TASKS_DISCOVERY_DOCS = ['https://www.googleapis.com/discovery/v1/apis/tasks/v1/rest'];
        const TASKS_SCOPES = 'https://www.googleapis.com/auth/tasks';

        // Active Filtering State
        let filters = {
            wrong: false,
            unattempted: false,
            marked: false,
            starred: false
        };

        // --- Firebase Configuration ---
        async function initializeFirebase() {
            try {
                // Wait briefly for the global `firebase` object to be available
                const start = Date.now();
                while (typeof window.firebase === 'undefined' && Date.now() - start < 5000) {
                    await new Promise(r => setTimeout(r, 200));
                }
                if (typeof window.firebase === 'undefined') {
                    console.error('Firebase global not found after 5s.');
                    alert('Firebase failed to load. Check the browser console and network tab for script loading errors.');
                    return;
                }

                const firebaseConfig = {
                    apiKey: "AIzaSyDXiGc0rzX6AgFMwKFr4M75V7obm7IlvCo",
                    authDomain: "study-portal-638a8.firebaseapp.com",
                    projectId: "study-portal-638a8",
                    storageBucket: "study-portal-638a8.firebasestorage.app",
                    messagingSenderId: "75874243415",
                    appId: "1:75874243415:web:7b5af602dafc7cb6de2412",
                    measurementId: "G-04Y81SX2K2"
                };

                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                auth = firebase.auth();
                db = firebase.firestore();

                // Setup auth state listener
                auth.onAuthStateChanged(async (user) => {
                    currentUser = user;
                    const userInfo = document.getElementById('user-info');
                    const signinBtn = document.getElementById('google-signin-btn');

                    if (user) {
                        userInfo.classList.remove('hidden');
                        userInfo.classList.add('flex');
                        signinBtn.classList.add('hidden');
                        document.getElementById('user-name').textContent = user.displayName || user.email;
                        document.getElementById('user-avatar').src = user.photoURL || 'https://via.placeholder.com/24';
                        await loadUserLibraryFromFirestore();
                        renderLibrary();
                    } else {
                        userInfo.classList.add('hidden');
                        userInfo.classList.remove('flex');
                        signinBtn.classList.remove('hidden');
                        library = {};
                        renderLibrary();
                    }
                });

                // Setup Google sign-in button
                const signinBtn = document.getElementById('google-signin-btn');
                if (signinBtn) {
                    signinBtn.onclick = async () => {
                        // OAuth popups won't work from file:// — guide the user
                        if (window.location.protocol === 'file:') {
                            alert('Google Sign-In requires the page to be served over HTTP/HTTPS (not file://).\nRun a quick local server (e.g. `python -m http.server 8000`) and open http://localhost:8000/checker.html');
                            return;
                        }

                        if (!auth) {
                            alert('Auth not initialized yet. Please refresh the page.');
                            return;
                        }

                        try {
                            const provider = new firebase.auth.GoogleAuthProvider();
                            await auth.signInWithPopup(provider);
                        } catch (error) {
                            console.error('Sign-in error:', error);
                            alert('Sign-in failed: ' + (error && error.message ? error.message : String(error)));
                        }
                    };
                }
            } catch (error) {
                console.error('Firebase initialization error:', error);
            }
        }

        function signOut() {
            if (auth) {
                auth.signOut()
                    .catch((error) => alert('Sign-out failed: ' + error.message));
            }
        }

        // --- Initialization ---
        window.onload = () => {
            applyTheme();
            setupFileUpload();
            initializeFirebase();
            loadLocalTodos();
            renderTodos();
            initializeGoogleTasksClient();
        };

        // --- Theme Logic ---
        function applyTheme() {
            if (currentTheme === 'dark') {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        }

        function toggleTheme() {
            currentTheme = currentTheme === 'light' ? 'dark' : 'light';
            localStorage.setItem('portal_theme', currentTheme);
            applyTheme();
        }

        function validateJSONSchema(data) {
            if (typeof data !== 'object' || data === null) return false;
            const sections = Object.keys(data);
            if (sections.length === 0) return false;
            for (let section of sections) {
                if (!Array.isArray(data[section].answers)) return false;
                if (!data[section].type) return false;
            }
            return true;
        }

        function setupFileUpload() {
            const fileIn = document.getElementById('newTestFile');
            const titleIn = document.getElementById('newTestTitle');
            const subjectIn = document.getElementById('newTestSubject');

            fileIn.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const title = titleIn.value.trim() || file.name.replace('.json', '');
                const subject = subjectIn ? subjectIn.value.trim() : '';
                const reader = new FileReader();
                reader.onload = (ev) => {
                    try {
                        const keyData = JSON.parse(ev.target.result);
                        if (!validateJSONSchema(keyData)) {
                            throw new Error("Invalid schema structure.");
                        }
                        const id = 'test_' + Date.now();

                        library[id] = {
                            id: id,
                            title: title,
                            subject: subject || '',
                            key: keyData,
                            progress: {},
                            timeSpent: 0,
                            timerMode: 'countup', // 'countup' or 'countdown'
                            timerLimit: 0, // in seconds
                            sessionGoal: 0,
                            timerRunning: false,
                            lastUpdate: Date.now()
                        };

                        saveAndSync();
                        titleIn.value = '';
                        if (subjectIn) subjectIn.value = '';
                        renderLibrary();
                    } catch (err) {
                        alert("Error: " + (err.message || "Invalid JSON format."));
                    }
                };
                reader.readAsText(file);
            };
        }

        // --- Firestore Data Sync ---
        async function loadUserLibraryFromFirestore() {
            if (!currentUser) return;

            try {
                const docRef = db.collection('users').doc(currentUser.uid);
                const docSnap = await docRef.get();

                if (docSnap.exists) {
                    library = docSnap.data().library || {};
                } else {
                    library = {};
                }
            } catch (error) {
                console.error('Error loading library from Firestore:', error);
                alert('Error loading data. Falling back to local version.');
            }
        }

        async function saveLibraryToFirestore() {
            if (!currentUser || isSyncing) return;

            isSyncing = true;
            try {
                await db.collection('users').doc(currentUser.uid).set({
                    library: library,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
                    email: currentUser.email
                });

                const indicator = document.getElementById('autosave-indicator');
                if (indicator) {
                    indicator.style.opacity = '1';
                    setTimeout(() => indicator.style.opacity = '0', 2000);
                }
            } catch (error) {
                console.error('Error saving to Firestore:', error);
            } finally {
                isSyncing = false;
            }
        }

        // --- Optimized Firestore Syncing ---
        function saveAndSync() {
            if (!currentUser) {
                // Fallback to localStorage if not signed in
                if (saveTimeout) clearTimeout(saveTimeout);
                saveTimeout = setTimeout(() => {
                    try {
                        localStorage.setItem('portal_library', JSON.stringify(library));
                        const indicator = document.getElementById('autosave-indicator');
                        if (indicator) {
                            indicator.style.opacity = '1';
                            setTimeout(() => indicator.style.opacity = '0', 2000);
                        }
                    } catch (e) {
                        console.error('Save error', e);
                    }
                }, 500);
                return;
            }

            if (saveTimeout) clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => {
                saveLibraryToFirestore();
            }, 500); // 500ms debounce
        }

        function formatTime(totalSeconds) {
            const isNegative = totalSeconds < 0;
            const absSecs = Math.abs(totalSeconds);
            const hrs = Math.floor(absSecs / 3600);
            const mins = Math.floor((absSecs % 3600) / 60);
            const secs = absSecs % 60;
            const timeStr = [hrs, mins, secs].map(v => v < 10 ? "0" + v : v).join(":");
            return isNegative ? "-" + timeStr : timeStr;
        }

        // --- Improved Answer Comparison ---
        function compareAnswers(user, key) {
            const cleanUser = Array.isArray(user) ? user.sort().join('') : user.trim().toUpperCase();
            const cleanKey = key.toString().toUpperCase().trim();
            if (cleanUser === cleanKey) return true;
            const numUser = parseFloat(cleanUser);
            const numKey = parseFloat(cleanKey);
            if (!isNaN(numUser) && !isNaN(numKey)) {
                return Math.abs(numUser - numKey) < 0.0001;
            }
            return false;
        }

        // --- Timer Logic ---
        function toggleTimer() {
            if (timerInterval) {
                stopTimer();
            } else {
                startTimer();
            }
        }

        function startTimer() {
            if (timerInterval) clearInterval(timerInterval);

            const playIcon = document.getElementById('timer-play-icon');
            const stopIcon = document.getElementById('timer-stop-icon');
            if (playIcon) playIcon.classList.add('hidden');
            if (stopIcon) stopIcon.classList.remove('hidden');

            if (activeTestId && library[activeTestId]) {
                library[activeTestId].timerRunning = true;
                library[activeTestId].lastUpdate = Date.now();
                saveAndSync();
            }

            timerInterval = setInterval(() => {
                if (activeTestId && library[activeTestId]) {
                    const test = library[activeTestId];
                    const now = Date.now();
                    const delta = Math.round((now - test.lastUpdate) / 1000);
                    test.lastUpdate = now;

                    if (test.timerMode === 'countdown') {
                        test.timerLimit -= delta;
                        test.timeSpent += delta;
                        const timerEl = document.getElementById('test-timer');
                        if (timerEl) timerEl.innerText = formatTime(test.timerLimit);
                        if (test.timerLimit <= 0) {
                            showTimerEnd();
                            stopTimer();
                        }
                    } else {
                        test.timeSpent += delta;
                        const timerEl = document.getElementById('test-timer');
                        if (timerEl) timerEl.innerText = formatTime(test.timeSpent);
                    }
                }
            }, 1000);
        }

        function stopTimer() {
            clearInterval(timerInterval);
            timerInterval = null;

            const playIcon = document.getElementById('timer-play-icon');
            const stopIcon = document.getElementById('timer-stop-icon');
            if (playIcon) playIcon.classList.remove('hidden');
            if (stopIcon) stopIcon.classList.add('hidden');

            if (activeTestId && library[activeTestId]) {
                library[activeTestId].timerRunning = false;
            }
            saveAndSync();
        }

        function openTimerSettings() {
            const test = library[activeTestId];
            document.getElementById('input-timer-mins').value = test.timerMode === 'countdown' ? Math.ceil(test.timerLimit / 60) : "";
            document.getElementById('input-goal-num').value = test.sessionGoal || "";
            document.getElementById('timerSettingsModal').classList.remove('hidden');
            document.getElementById('timerSettingsModal').classList.add('flex');
        }

        function saveTimerSettings() {
            const mins = parseInt(document.getElementById('input-timer-mins').value) || 0;
            const goal = parseInt(document.getElementById('input-goal-num').value) || 0;
            const test = library[activeTestId];

            const wasRunning = timerInterval !== null;
            stopTimer();

            if (mins > 0) {
                test.timerMode = 'countdown';
                test.timerLimit = mins * 60;
            } else {
                test.timerMode = 'countup';
            }

            test.sessionGoal = goal;
            saveAndSync();
            closeModal('timerSettingsModal');
            updateWorkspaceTimerUI();

            if (wasRunning) startTimer();
        }

        function updateWorkspaceTimerUI() {
            const test = library[activeTestId];
            const goalArea = document.getElementById('active-goal-stats');
            const goalNum = document.getElementById('display-goal-num');

            if (test.sessionGoal > 0) {
                goalArea.classList.remove('hidden');
                goalArea.classList.add('flex');
                goalNum.innerText = test.sessionGoal;
            } else {
                goalArea.classList.add('hidden');
                goalArea.classList.remove('flex');
            }

            const timerEl = document.getElementById('test-timer');
            if (timerEl) {
                timerEl.innerText = test.timerMode === 'countdown' ? formatTime(test.timerLimit) : formatTime(test.timeSpent);
            }

            const playIcon = document.getElementById('timer-play-icon');
            const stopIcon = document.getElementById('timer-stop-icon');
            if (timerInterval) {
                if (playIcon) playIcon.classList.add('hidden');
                if (stopIcon) stopIcon.classList.remove('hidden');
            } else {
                if (playIcon) playIcon.classList.remove('hidden');
                if (stopIcon) stopIcon.classList.add('hidden');
            }
        }

        function showTimerEnd() {
            const modal = document.getElementById('timerEndModal');
            if (modal) {
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            }
        }

        // --- Filtering Logic ---
        function toggleFilter(type) {
            filters[type] = !filters[type];
            updateFilterUI();
            renderQuestions();
        }

        function clearFilters() {
            filters = { wrong: false, unattempted: false, marked: false, starred: false };
            updateFilterUI();
            renderQuestions();
        }

        function updateFilterUI() {
            const anyActive = filters.wrong || filters.unattempted || filters.marked || filters.starred;
            document.getElementById('filter-clear').classList.toggle('hidden', !anyActive);

            Object.keys(filters).forEach(key => {
                const btn = document.getElementById(`filter-${key}`);
                if (btn) {
                    if (filters[key]) {
                        btn.classList.add('bg-blue-600', 'text-white', 'border-blue-600');
                        btn.classList.remove('bg-white', 'dark:bg-slate-800', 'text-slate-800', 'dark:text-slate-300', 'border-slate-200', 'dark:border-slate-700');
                    } else {
                        btn.classList.remove('bg-blue-600', 'text-white', 'border-blue-600');
                        btn.classList.add('bg-white', 'dark:bg-slate-800', 'text-slate-800', 'dark:text-slate-300', 'border-slate-200', 'dark:border-slate-700');
                    }
                }
            });
        }

        // --- Navigation ---
        function goHome() {
            stopTimer();
            saveAndSync();
            document.getElementById('view-home').classList.remove('hidden');
            document.getElementById('view-test').classList.add('hidden');
            activeTestId = null;
            clearFilters();
            renderLibrary();
        }

        function openTest(id) {
            try {
                activeTestId = id;
                const test = library[id];
                document.getElementById('view-home').classList.add('hidden');
                document.getElementById('view-test').classList.remove('hidden');
                document.getElementById('active-test-title').innerText = test.title;

                if (test.timerRunning) {
                    const now = Date.now();
                    const delta = Math.round((now - test.lastUpdate) / 1000);
                    test.lastUpdate = now;
                    if (test.timerMode === 'countdown') {
                        test.timerLimit -= delta;
                        test.timeSpent += delta;
                    } else {
                        test.timeSpent += delta;
                    }
                    updateWorkspaceTimerUI();
                    startTimer();
                } else {
                    updateWorkspaceTimerUI();
                }

                const sections = Object.keys(test.key);
                renderSectionTabs(sections);
                loadSection(sections[0]);
            } catch (err) {
                console.error("Failed to open test", err);
                goHome();
            }
        }

        // --- Rendering Home ---
        function renderLibrary() {
            try {
                const container = document.getElementById('test-library');
                const countEl = document.getElementById('test-count');
                container.innerHTML = '';

                const ids = Object.keys(library);
                countEl.innerText = ids.length;

                if (ids.length === 0) {
                    container.innerHTML = `<div class="col-span-full text-center py-12 text-slate-400 italic">No tests uploaded yet.</div>`;
                    return;
                }

                // Group tests by subject, with "Uncategorised" last
                const groups = {};
                ids.forEach(id => {
                    const test = library[id];
                    if (!test || !test.key) return;
                    const subjectLabel = (test.subject && String(test.subject).trim()) ? String(test.subject).trim() : 'Uncategorised';
                    if (!groups[subjectLabel]) groups[subjectLabel] = [];
                    groups[subjectLabel].push(id);
                });

                const allSubjects = Object.keys(groups).sort((a, b) => {
                    if (a === 'Uncategorised') return 1;
                    if (b === 'Uncategorised') return -1;
                    return a.localeCompare(b);
                });

                allSubjects.forEach(subjectName => {
                    const subjectTests = groups[subjectName];

                    // Subject header
                    const header = document.createElement('div');
                    header.className = 'col-span-full flex items-center justify-between mb-2 mt-4 first:mt-0';
                    header.innerHTML = `
                        <div class="flex items-center gap-2">
                            <span class="text-sm font-semibold text-slate-700 dark:text-slate-200">${subjectName}</span>
                            <span class="text-[10px] px-2 py-0.5 rounded-full bg-slate-100 dark:bg-slate-800 text-slate-500 dark:text-slate-400 font-bold uppercase tracking-widest">${subjectTests.length} test${subjectTests.length !== 1 ? 's' : ''}</span>
                        </div>
                    `;
                    container.appendChild(header);

                    subjectTests.forEach(id => {
                        const test = library[id];
                        if (!test || !test.key) return;

                        let totalQ = 0, attemptedQ = 0, completedQ = 0;

                        Object.keys(test.key).forEach(s => {
                            const sAns = test.key[s].answers;
                            const sProg = test.progress ? (test.progress[s] || {}) : {};
                            totalQ += sAns.length;

                            sAns.forEach((_, idx) => {
                                const q = sProg[idx];
                                if (q) {
                                    if (q.submitted) completedQ++;
                                    const hasAns = Array.isArray(q.userAns) ? q.userAns.length > 0 : (q.userAns && q.userAns.toString().trim() !== "");
                                    if (hasAns) attemptedQ++;
                                }
                            });
                        });

                        const completedPct = totalQ > 0 ? Math.round((completedQ / totalQ) * 100) : 0;
                        const attemptedPct = totalQ > 0 ? Math.round((attemptedQ / totalQ) * 100) : 0;
                        const subjectLabel = (test.subject && String(test.subject).trim()) ? String(test.subject).trim() : 'Uncategorised';

                        const card = document.createElement('div');
                        card.className = 'glass p-6 rounded-2xl border border-slate-200 dark:border-slate-800 card-shadow hover:scale-[1.02] transition cursor-pointer relative group';
                        card.onclick = () => openTest(id);
                        card.innerHTML = `
                        <div class="absolute top-4 right-4 flex gap-2 opacity-0 group-hover:opacity-100 transition">
                            <button onclick="event.stopPropagation(); openKeyViewer('${id}')" title="View answer key" class="text-slate-400 hover:text-emerald-500 transition">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                            </button>
                            <button onclick="event.stopPropagation(); exportSingleTest('${id}')" title="Export Test" class="text-slate-400 hover:text-blue-500 transition">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                            </button>
                            <button onclick="event.stopPropagation(); openEditTest('${id}')" title="Edit Test" class="text-slate-400 hover:text-slate-600 transition">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M6 10a2 2 0 114 0 2 2 0 01-4 0z" />
                                    <path fill-rule="evenodd" d="M4 5a2 2 0 012-2h8a2 2 0 012 2v10a1 1 0 01-1.447.894L12 14.618l-4.553 1.276A1 1 0 016 14.894V5z" clip-rule="evenodd" />
                                </svg>
                            </button>
                            <button onclick="event.stopPropagation(); deleteTest('${id}')" title="Delete Test" class="text-slate-400 hover:text-red-500 transition">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                            </button>
                        </div>
                        <h3 class="font-bold text-lg mb-1 text-slate-800 dark:text-white pr-12">${test.title}</h3>
                        <p class="mb-3 text-[11px] text-slate-500 dark:text-slate-400">
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full bg-slate-100 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 uppercase tracking-widest font-bold text-[9px]">
                                ${subjectLabel}
                            </span>
                        </p>
                        <div class="space-y-2">
                            <div class="flex justify-between text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider">
                                <span>Completed</span>
                                <span>${completedPct}%</span>
                            </div>
                            <div class="w-full h-2 bg-slate-100 dark:bg-slate-800 rounded-full overflow-hidden relative">
                                <!-- Attempted Layer (Light Blue) -->
                                <div class="absolute h-full bg-blue-400/40 dark:bg-blue-500/20 transition-all duration-500" style="width: ${attemptedPct}%"></div>
                                <!-- Submitted Layer (Vibrant Blue) -->
                                <div class="absolute h-full bg-blue-600 dark:bg-blue-500 transition-all duration-500 shadow-[0_0_8px_rgba(37,99,235,0.3)]" style="width: ${completedPct}%"></div>
                            </div>
                            <div class="flex justify-between items-center text-[10px] text-slate-400 dark:text-slate-500 mt-1 font-medium uppercase tracking-tight">
                                <span>${completedQ}/${totalQ} Submitted • ${attemptedQ} Attempted</span>
                                <span class="font-mono">${formatTime(test.timeSpent || 0)}</span>
                            </div>
                        </div>
                    `;
                        container.appendChild(card);
                    });
                });
            } catch (err) {
                console.error("Render Library Error", err);
            }
        }

        function openEditTest(id) {
            const test = library[id];
            if (!test) return;
            editingTestId = id;
            const titleInput = document.getElementById('edit-test-title');
            const subjectInput = document.getElementById('edit-test-subject');
            if (titleInput) titleInput.value = test.title || '';
            if (subjectInput) subjectInput.value = test.subject || '';

            const modal = document.getElementById('editTestModal');
            if (modal) {
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            }
        }

        function saveTestEdits() {
            if (!editingTestId || !library[editingTestId]) {
                closeModal('editTestModal');
                editingTestId = null;
                return;
            }
            const test = library[editingTestId];
            const titleInput = document.getElementById('edit-test-title');
            const subjectInput = document.getElementById('edit-test-subject');

            const newTitle = titleInput ? titleInput.value.trim() : '';
            const newSubject = subjectInput ? subjectInput.value.trim() : '';

            if (newTitle) test.title = newTitle;
            test.subject = newSubject || '';

            saveAndSync();
            renderLibrary();
            closeModal('editTestModal');
            editingTestId = null;
        }

        function deleteTest(id) {
            if (confirm("Delete this test and all progress?")) {
                delete library[id];
                saveAndSync();
                renderLibrary();
            }
        }

        function copyExtractionPrompt() {
            const promptText = `You are extracting an answer key from screenshots of a test.
Carefully read the uploaded image(s) and convert the answers into a JSON object that matches EXACTLY the following schema:
{
"Section Name": {
"type": "single | multi | numerical",
"answers": [...]
}
}
Rules:

Detect section headers (e.g., "SECTION (B): MULTIPLE CHOICE QUESTIONS (MULTIPLE OPTIONS CORRECT)", "SECTION (C): ASSERTION-REASONING", etc.).
Use the section title as the JSON key
Determine question type:
If multiple options like "A, B, D" → type = "multi"
If single letter like "A" → type = "single"
If numbers or decimals → type = "numerical"
Preserve answer order strictly by question number.
For multi answers:
Remove spaces
Combine letters into a string (e.g., "ABD", "ACD").
For single answers:
Use a single letter string (e.g., "A").
For numerical answers:
Use numbers or decimal values exactly as shown.
Ignore formatting artifacts like dots, alignment marks, or page decorations.
Do NOT add explanations.
Output ONLY valid JSON — no markdown, no commentary.
Example format:
{
"Multi Correct": {
"type": "multi",
"answers": ["AD", "BD", "ACD"]
},
"Comprehension": {
"type": "single",
"answers": ["C", "A", "B"]
},
"Integer": {
"type": "numerical",
"answers": [4, 6, 3]
}
}
Now extract the answers from the uploaded screenshot(s).

Double-check for OCR mistakes before finalizing.

If uncertain about any answer, mark it as null instead of guessing.`;

            const textArea = document.createElement("textarea");
            textArea.value = promptText;
            textArea.style.position = "fixed";
            textArea.style.left = "-9999px";
            textArea.style.top = "0";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();

            try {
                document.execCommand('copy');
                const indicator = document.getElementById('autosave-indicator');
                if (indicator) {
                    const originalText = indicator.innerText;
                    indicator.innerText = 'Prompt Copied! ✓';
                    indicator.style.opacity = '1';
                    setTimeout(() => {
                        indicator.style.opacity = '0';
                        setTimeout(() => indicator.innerText = originalText, 300);
                    }, 2000);
                }
            } catch (err) {
                console.error('Copy failed', err);
            }

            document.body.removeChild(textArea);
        }

        // --- To-Do List (Local + Google Tasks) ---

        function loadLocalTodos() {
            try {
                const raw = localStorage.getItem('portal_todos');
                if (!raw) {
                    todos = [];
                    return;
                }
                const parsed = JSON.parse(raw);
                if (Array.isArray(parsed)) {
                    todos = parsed;
                } else {
                    todos = [];
                }
            } catch (e) {
                console.error('Failed to load todos from localStorage', e);
                todos = [];
            }
        }

        function saveLocalTodos() {
            try {
                localStorage.setItem('portal_todos', JSON.stringify(todos));
            } catch (e) {
                console.error('Failed to save todos', e);
            }
        }

        function renderTodos() {
            const listEl = document.getElementById('todo-list');
            const countEl = document.getElementById('todo-count');
            if (!listEl || !countEl) return;

            listEl.innerHTML = '';
            if (!todos.length) {
                listEl.innerHTML = `<div class="text-xs text-slate-400 dark:text-slate-500 italic">No tasks yet. Add your first to‑do above.</div>`;
                countEl.innerText = '0 tasks';
                return;
            }

            todos.forEach((t, idx) => {
                const row = document.createElement('div');
                row.className = 'flex items-center gap-2 bg-white dark:bg-slate-800/80 border border-slate-200 dark:border-slate-700 rounded-lg px-3 py-2';

                if (editingTodoIndex === idx) {
                    // Edit Mode UI
                    row.innerHTML = `
                        <input type="text" id="edit-todo-text-${idx}" value="${t.text}" class="flex-1 px-2 py-1 rounded border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-900 text-xs text-slate-900 dark:text-white outline-none focus:ring-1 focus:ring-blue-500">
                        <input type="date" id="edit-todo-date-${idx}" value="${t.due || ''}" class="px-2 py-1 rounded border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-900 text-xs text-slate-900 dark:text-white outline-none focus:ring-1 focus:ring-blue-500">
                        <button onclick="saveEdit(${idx})" class="text-emerald-500 hover:text-emerald-600 font-bold px-1" title="Save">✔</button>
                        <button onclick="cancelEdit()" class="text-slate-400 hover:text-slate-500 font-bold px-1" title="Cancel">✕</button>
                    `;
                } else {
                    // View Mode UI
                    let dueDateHtml = '';
                    if (t.due) {
                        const dateObj = new Date(t.due);
                        const dateStr = dateObj.toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
                        dueDateHtml = `<span class="text-[10px] text-slate-400 dark:text-slate-500 border border-slate-200 dark:border-slate-700 rounded px-1.5 py-0.5 whitespace-nowrap flex items-center gap-1">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" />
                            </svg>
                            ${dateStr}
                        </span>`;
                    }

                    row.innerHTML = `
                        <button onclick="toggleTodoCompleted(${idx})" class="w-4 h-4 rounded border flex items-center justify-center text-[10px] ${t.completed ? 'bg-emerald-500 border-emerald-500 text-white' : 'border-slate-300 dark:border-slate-600 text-transparent'}">
                            ✓
                        </button>
                        <div class="flex-1 text-xs sm:text-sm ${t.completed ? 'line-through text-slate-400 dark:text-slate-500' : ''} flex items-center flex-wrap gap-2">
                            <span>${t.text}</span>
                            ${dueDateHtml}
                        </div>
                        <button onclick="startEdit(${idx})" class="text-slate-300 hover:text-blue-500 transition text-xs mr-1" title="Edit">✎</button>
                        <button onclick="deleteTodo(${idx})" class="text-slate-300 hover:text-rose-500 transition text-xs" title="Delete">✕</button>
                    `;
                }
                listEl.appendChild(row);
            });

            const remaining = todos.filter(t => !t.completed).length;
            const plural = todos.length === 1 ? 'task' : 'tasks';
            countEl.innerText = `${todos.length} ${plural} (${remaining} left)`;
        }

        function addTodo() {
            const input = document.getElementById('todo-input');
            const dateInput = document.getElementById('todo-due-date');
            if (!input) return;
            const text = input.value.trim();
            if (!text) return;

            let due = null;
            if (dateInput && dateInput.value) {
                // Store as YYYY-MM-DD string locally or just invoke date string
                due = dateInput.value;
            }

            const todo = { text, completed: false, googleTaskId: null, due: due };
            todos.unshift(todo);
            input.value = '';
            if (dateInput) dateInput.value = ''; // Reset date picker
            saveLocalTodos();
            renderTodos();

            // If Google Tasks is ready and signed in, also create remotely
            if (tasksClientInitialized && tasksSignedIn && typeof gapi !== 'undefined' && gapi.client && gapi.client.tasks) {
                createGoogleTaskForTodo(todo);
            }
        }

        function toggleTodoCompleted(idx) {
            if (idx < 0 || idx >= todos.length) return;
            const todo = todos[idx];
            todo.completed = !todo.completed;
            saveLocalTodos();
            renderTodos();

            if (tasksClientInitialized && tasksSignedIn && todo.googleTaskId && typeof gapi !== 'undefined' && gapi.client && gapi.client.tasks) {
                updateGoogleTaskCompletion(todo.googleTaskId, todo.completed);
            }
        }

        function deleteTodo(idx) {
            if (idx < 0 || idx >= todos.length) return;
            const todo = todos[idx];
            todos.splice(idx, 1);
            saveLocalTodos();
            renderTodos();

            if (tasksClientInitialized && tasksSignedIn && todo.googleTaskId && typeof gapi !== 'undefined' && gapi.client && gapi.client.tasks) {
                deleteGoogleTask(todo.googleTaskId);
            }
        }

        function startEdit(idx) {
            editingTodoIndex = idx;
            renderTodos();

            // Focus the text input
            setTimeout(() => {
                const input = document.getElementById(`edit-todo-text-${idx}`);
                if (input) input.focus();
            }, 50);
        }

        function cancelEdit() {
            editingTodoIndex = null;
            renderTodos();
        }

        function saveEdit(idx) {
            const textInput = document.getElementById(`edit-todo-text-${idx}`);
            const dateInput = document.getElementById(`edit-todo-date-${idx}`);
            if (!textInput) return;

            const newText = textInput.value.trim();
            if (!newText) {
                alert("Task cannot be empty.");
                return;
            }

            const newDue = dateInput && dateInput.value ? dateInput.value : null;
            const todo = todos[idx];

            todo.text = newText;
            todo.due = newDue;

            editingTodoIndex = null;
            saveLocalTodos();
            renderTodos();

            if (tasksClientInitialized && tasksSignedIn && todo.googleTaskId && typeof gapi !== 'undefined' && gapi.client && gapi.client.tasks) {
                updateGoogleTask(todo);
            }
        }

        function clearCompletedTodos() {
            const remaining = todos.filter(t => !t.completed);
            const removed = todos.length - remaining.length;
            if (!removed) return;
            todos = remaining;
            saveLocalTodos();
            renderTodos();
        }

        function updateTasksStatus(message, tone = 'neutral') {
            const statusEl = document.getElementById('tasks-status');
            if (!statusEl) return;
            statusEl.innerText = message;
            statusEl.classList.remove('text-amber-500', 'dark:text-amber-300', 'text-emerald-500', 'dark:text-emerald-300', 'text-rose-500', 'dark:text-rose-300');

            if (tone === 'warning') {
                statusEl.classList.add('text-amber-500', 'dark:text-amber-300');
            } else if (tone === 'success') {
                statusEl.classList.add('text-emerald-500', 'dark:text-emerald-300');
            } else if (tone === 'error') {
                statusEl.classList.add('text-rose-500', 'dark:text-rose-300');
            } else {
                statusEl.classList.add('text-amber-500', 'dark:text-amber-300');
            }
        }

        function updateTasksAuthUI() {
            const btn = document.getElementById('tasks-connect-btn');
            if (!btn) return;
            if (tasksSignedIn) {
                btn.innerText = 'Disconnect Tasks';
                btn.classList.remove('bg-blue-50', 'dark:bg-blue-900/30', 'text-blue-700', 'dark:text-blue-300');
                btn.classList.add('bg-slate-100', 'dark:bg-slate-800', 'text-slate-700', 'dark:text-slate-200');
                updateTasksStatus('Synced with your default Google Tasks list.', 'success');
            } else {
                btn.innerText = 'Connect Google Tasks';
                btn.classList.add('bg-blue-50', 'dark:bg-blue-900/30', 'text-blue-700', 'dark:text-blue-300');
                btn.classList.remove('bg-slate-100', 'dark:bg-slate-800', 'text-slate-700', 'dark:text-slate-200');
                updateTasksStatus('Google Tasks not connected. You can still add local to‑dos (not synced).', 'warning');
            }
        }

        function handleTasksAuthClick() {
            if (!tokenClient) {
                alert('Google Tasks client is still loading. Please try again in a moment.');
                return;
            }

            if (tasksSignedIn) {
                // GIS doesn't have a direct "signOut" method like gapi.auth2.
                // We simply clear our local state and the access token.
                // To truly revoke, you'd allow the user to revoke permissions, but for this app, 
                // clearing the session state is usually sufficient for "disconnect".
                const token = gapi.client.getToken();
                if (token !== null) {
                    google.accounts.oauth2.revoke(token.access_token, () => {
                        console.log('Token revoked.');
                    });
                    gapi.client.setToken('');
                }
                tasksSignedIn = false;
                accessToken = null;
                localStorage.removeItem('portal_tasks_token');
                localStorage.removeItem('portal_tasks_token_expiry');
                updateTasksAuthUI();
                updateTasksStatus('Disconnected from Google Tasks.', 'neutral');
            } else {
                if (gapi.client.getToken() === null) {
                    // Prompt the user to select a Google Account and ask for consent to share their data
                    // when establishing a new session.
                    tokenClient.requestAccessToken({ prompt: 'consent' });
                } else {
                    // Skip display of account chooser and consent dialog for an existing session.
                    tokenClient.requestAccessToken({ prompt: '' });
                }
            }
        }

        function restoreTasksSession() {
            const storedToken = localStorage.getItem('portal_tasks_token');
            const storedExpiry = localStorage.getItem('portal_tasks_token_expiry');

            if (storedToken && storedExpiry) {
                if (Date.now() < parseInt(storedExpiry)) {
                    gapi.client.setToken({ access_token: storedToken });
                    tasksSignedIn = true;
                    accessToken = storedToken;
                    updateTasksAuthUI();
                    fetchGoogleTasksIntoTodos();
                    console.log('Restored Google Tasks session from storage.');
                } else {
                    console.log('Stored token expired.');
                    localStorage.removeItem('portal_tasks_token');
                    localStorage.removeItem('portal_tasks_token_expiry');
                }
            }
        }

        async function initializeGoogleTasksClient() {
            // If the developer hasn't configured the keys yet, keep everything local-only.
            if (TASKS_CLIENT_ID.startsWith('REPLACE_') || TASKS_API_KEY.startsWith('REPLACE_')) {
                console.info('Google Tasks keys not configured; to‑dos will remain local-only.');
                return;
            }

            const start = Date.now();
            const maxWait = 5000;
            const waitForGapi = async () => {
                while (typeof gapi === 'undefined' && Date.now() - start < maxWait) {
                    await new Promise(r => setTimeout(r, 200));
                }
            };

            await waitForGapi();
            if (typeof gapi === 'undefined') {
                console.warn('gapi not available; Google Tasks integration disabled.');
                return;
            }

            gapi.load('client', async () => {
                try {
                    await gapi.client.init({
                        apiKey: TASKS_API_KEY,
                        discoveryDocs: TASKS_DISCOVERY_DOCS,
                    });

                    tasksClientInitialized = true;

                    // Initialize the Token Client
                    tokenClient = google.accounts.oauth2.initTokenClient({
                        client_id: TASKS_CLIENT_ID,
                        scope: TASKS_SCOPES,
                        callback: (tokenResponse) => {
                            if (tokenResponse && tokenResponse.access_token) {
                                tasksSignedIn = true;
                                accessToken = tokenResponse.access_token;

                                // Save token (expires_in is usually 3599 seconds)
                                const expiresIn = tokenResponse.expires_in || 3599;
                                const expiryTime = Date.now() + (expiresIn * 1000);
                                localStorage.setItem('portal_tasks_token', accessToken);
                                localStorage.setItem('portal_tasks_token_expiry', expiryTime);

                                updateTasksAuthUI();
                                fetchGoogleTasksIntoTodos();
                            }
                        },
                    });

                    restoreTasksSession();
                    updateTasksAuthUI();
                } catch (e) {
                    console.error('Failed to initialize Google Tasks client', e);
                    updateTasksStatus('Google Tasks setup failed; using local to‑dos only.', 'error');
                }
            });
        }

        async function fetchGoogleTasksIntoTodos() {
            if (!tasksClientInitialized || !tasksSignedIn || !gapi.client || !gapi.client.tasks) return;
            try {
                const response = await gapi.client.tasks.tasks.list({
                    tasklist: '@default',
                    showCompleted: true,
                    maxResults: 50
                });
                const items = response.result.items || [];

                // Merge remote tasks into local list by text label
                const byText = new Map();
                todos.forEach(t => {
                    byText.set(t.text, t);
                });

                items.forEach(item => {
                    const text = item.title || '';
                    if (!text) return;
                    const completed = typeof item.status === 'string' && item.status === 'completed'; // status is 'needsAction' or 'completed'

                    // Parse due date if present (RFC 3339 timestamp)
                    let due = null;
                    if (item.due) {
                        // Google Tasks returns a full timestamp string like "2023-10-26T00:00:00.000Z"
                        // We just want YYYY-MM-DD for our local logic/input
                        due = item.due.split('T')[0];
                    }

                    const existing = byText.get(text);
                    if (existing) {
                        existing.completed = completed;
                        existing.googleTaskId = item.id;
                        if (due) existing.due = due;
                    } else {
                        todos.push({
                            text,
                            completed,
                            googleTaskId: item.id,
                            due: due
                        });
                    }
                });

                saveLocalTodos();
                renderTodos();
                updateTasksStatus('Synced with Google Tasks (@default list).', 'success');
            } catch (e) {
                console.error('Failed to fetch Google Tasks', e);
                updateTasksStatus('Could not load Google Tasks; working from local list only.', 'error');
            }
        }

        async function createGoogleTaskForTodo(todo) {
            try {
                const res = await gapi.client.tasks.tasks.insert({
                    tasklist: '@default',
                    resource: {
                        title: todo.text,
                        status: todo.completed ? 'completed' : 'needsAction',
                        due: todo.due ? new Date(todo.due).toISOString() : undefined
                    }
                });
                if (res && res.result && res.result.id) {
                    todo.googleTaskId = res.result.id;
                    saveLocalTodos();
                }
            } catch (e) {
                console.error('Failed to create Google Task', e);
            }
        }

        async function updateGoogleTaskCompletion(taskId, completed) {
            try {
                const res = await gapi.client.tasks.tasks.get({
                    tasklist: '@default',
                    task: taskId
                });
                const task = res.result;
                task.status = completed ? 'completed' : 'needsAction';
                if (completed) {
                    task.completed = new Date().toISOString();
                } else {
                    task.completed = null;
                }
                await gapi.client.tasks.tasks.update({
                    tasklist: '@default',
                    task: taskId,
                    resource: task
                });
            } catch (e) {
                console.error('Failed to update Google Task completion', e);
            }
        }

        async function deleteGoogleTask(taskId) {
            try {
                await gapi.client.tasks.tasks.delete({
                    tasklist: '@default',
                    task: taskId
                });
            } catch (e) {
                console.error('Failed to delete Google Task', e);
            }
        }

        async function updateGoogleTask(todo) {
            try {
                // First get existing task to preserve other fields if needed, 
                // but mainly we just overwrite title and due date.
                const res = await gapi.client.tasks.tasks.get({
                    tasklist: '@default',
                    task: todo.googleTaskId
                });
                const task = res.result;

                task.title = todo.text;
                task.due = todo.due ? new Date(todo.due).toISOString() : null; // Parsing 'YYYY-MM-DD' creates a UTC midnight date, which is what we want for full-day tasks usually

                await gapi.client.tasks.tasks.update({
                    tasklist: '@default',
                    task: todo.googleTaskId,
                    resource: task
                });
            } catch (e) {
                console.error('Failed to update Google Task', e);
            }
        }

        // --- Rendering Workspace ---
        function renderSectionTabs(sections) {
            const container = document.getElementById('section-tabs');
            if (!container) return;
            container.innerHTML = '';
            sections.forEach(s => {
                const btn = document.createElement('button');
                btn.className = `px-4 py-2 rounded-lg text-sm font-semibold whitespace-nowrap border border-transparent transition`;
                btn.id = `tab-${s.replace(/\s/g, '-')}`;
                btn.innerText = s;
                btn.onclick = () => loadSection(s);
                container.appendChild(btn);
            });
        }

        function loadSection(sName) {
            activeSection = sName;
            document.querySelectorAll('#section-tabs button').forEach(b => {
                b.classList.remove('bg-white', 'dark:bg-slate-800', 'text-blue-600', 'dark:text-blue-400', 'border-slate-200', 'dark:border-slate-700', 'shadow-sm');
                b.classList.add('text-slate-500', 'dark:text-slate-400');
            });
            const activeTab = document.getElementById(`tab-${sName.replace(/\s/g, '-')}`);
            if (activeTab) {
                activeTab.classList.add('bg-white', 'dark:bg-slate-800', 'text-blue-600', 'dark:text-blue-400', 'border-slate-200', 'dark:border-slate-700', 'shadow-sm');
                activeTab.classList.remove('text-slate-500', 'dark:text-slate-400');
            }

            renderQuestions();
        }

        function renderQuestions() {
            try {
                const container = document.getElementById('question-grid');
                if (!container) return;
                container.innerHTML = '';
                const test = library[activeTestId];
                const section = test.key[activeSection];
                const progress = test.progress[activeSection] || {};

                const isAnyFilterActive = filters.wrong || filters.unattempted || filters.marked || filters.starred;

                section.answers.forEach((ans, idx) => {
                    const prog = progress[idx] || { userAns: section.type === 'multi' ? [] : "", submitted: false, marked: false, starred: false };

                    if (isAnyFilterActive) {
                        let match = false;
                        if (filters.wrong && prog.submitted && !prog.correct) match = true;
                        if (filters.unattempted && !prog.submitted) match = true;
                        if (filters.marked && prog.marked) match = true;
                        if (filters.starred && prog.starred) match = true;
                        if (!match) return;
                    }

                    const card = document.createElement('div');
                    card.className = `glass p-6 rounded-2xl border transition relative ${prog.marked ? 'marked-tint' : ''} ${prog.starred ? 'starred-glow' : ''} ${prog.submitted ? 'border-blue-100 dark:border-blue-900/50 bg-blue-50/30 dark:bg-blue-900/10' : 'border-slate-200 dark:border-slate-800'}`;

                    const qHeader = `
                        <div class="flex justify-between items-start mb-4">
                            <span class="text-sm font-bold text-slate-400 dark:text-slate-500 uppercase tracking-widest">Q${idx + 1}</span>
                            <div class="flex gap-1">
                                <button onclick="toggleStar(${idx})" class="p-1 rounded-full transition ${prog.starred ? 'text-amber-500 bg-amber-50 dark:bg-amber-900/30' : 'text-slate-300 dark:text-slate-600 hover:text-amber-400'}">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                        <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                                    </svg>
                                </button>
                                <button onclick="toggleMark(${idx})" class="p-1 rounded-full transition ${prog.marked ? 'text-blue-600 dark:text-blue-400 bg-blue-100 dark:bg-blue-900/30' : 'text-slate-300 dark:text-slate-600 hover:text-slate-500'}">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                        <path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                    `;

                    let inputHtml = '';
                    if (section.type === 'single' || (activeSection === "Section G (Match)" && idx >= 6)) {
                        inputHtml = `<div class="flex gap-2">` + ['A', 'B', 'C', 'D'].map(o => `
                            <button onclick="selectSingle(${idx}, '${o}')" ${prog.submitted ? 'disabled' : ''} 
                                class="flex-1 py-2 rounded-lg border font-bold transition ${prog.userAns === o ? 'bg-blue-600 border-blue-600 text-white' : 'bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-700 text-slate-600 dark:text-slate-400 hover:border-blue-300 dark:hover:border-blue-800'}">
                                ${o}
                            </button>
                        `).join('') + `</div>`;
                    } else if (section.type === 'multi') {
                        inputHtml = `<div class="flex gap-2">` + ['A', 'B', 'C', 'D'].map(o => `
                            <button onclick="selectMulti(${idx}, '${o}')" ${prog.submitted ? 'disabled' : ''} 
                                class="flex-1 py-2 rounded-lg border font-bold transition ${prog.userAns.includes(o) ? 'bg-blue-600 border-blue-600 text-white' : 'bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-700 text-slate-600 dark:text-slate-400 hover:border-blue-300 dark:hover:border-blue-800'}">
                                ${o}
                            </button>
                        `).join('') + `</div>`;
                    } else {
                        inputHtml = `<div class="relative"><input type="text" placeholder="Your Answer" value="${prog.userAns || ''}" oninput="updateText(${idx}, this.value)" ${prog.submitted ? 'disabled' : ''} 
                            class="w-full px-4 py-2 rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 text-slate-900 dark:text-white outline-none focus:ring-2 focus:ring-blue-500 disabled:bg-slate-50 dark:disabled:bg-slate-900/50">
                            ${!prog.submitted && prog.userAns ? `<button onclick="updateText(${idx}, ''); renderQuestions();" class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-rose-500 transition">✕</button>` : ''}
                            </div>`;
                    }

                    const submitBtn = `<button onclick="submitQuestion(${idx})" ${prog.submitted ? 'disabled' : ''} 
                        class="w-full mt-4 py-3 rounded-xl font-bold transition ${prog.submitted ? 'bg-slate-200 dark:bg-slate-800 text-slate-500 dark:text-slate-600' : 'bg-slate-900 dark:bg-white text-white dark:text-slate-900 hover:bg-slate-800 dark:hover:bg-slate-100'}">
                        ${prog.submitted ? 'Submitted' : 'Submit Answer'}
                    </button>`;

                    const feedback = `<div class="mt-4 pt-4 border-t border-slate-100 dark:border-slate-800 ${prog.submitted ? 'block' : 'hidden'}">
                        ${prog.correct ? '<span class="text-emerald-600 dark:text-emerald-400 font-bold text-sm">✓ Correct</span>' : `<span class="text-rose-500 dark:text-rose-400 font-bold text-sm">✗ Incorrect</span> <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">Ans: ${ans}</p>`}
                    </div>`;

                    card.innerHTML = qHeader + inputHtml + submitBtn + feedback;
                    container.appendChild(card);
                });

                if (container.innerHTML === '') {
                    container.innerHTML = `<div class="col-span-full text-center py-12 text-slate-400 dark:text-slate-500 italic">No questions match the current filters.</div>`;
                }

            } catch (err) {
                console.error("Render Questions Error", err);
            }
        }

        // --- Interaction Logic ---
        function toggleMark(qIdx) {
            initSectionProgress();
            const prog = library[activeTestId].progress[activeSection][qIdx];
            prog.marked = !prog.marked;
            saveAndSync();
            renderQuestions();
        }

        function toggleStar(qIdx) {
            initSectionProgress();
            const prog = library[activeTestId].progress[activeSection][qIdx];
            prog.starred = !prog.starred;
            saveAndSync();
            renderQuestions();
        }

        function selectSingle(qIdx, val) {
            initSectionProgress();
            const currentAns = library[activeTestId].progress[activeSection][qIdx].userAns;
            library[activeTestId].progress[activeSection][qIdx].userAns = (currentAns === val) ? "" : val;
            renderQuestions();
        }

        function selectMulti(qIdx, val) {
            initSectionProgress();
            let current = library[activeTestId].progress[activeSection][qIdx].userAns;
            if (!Array.isArray(current)) current = [];
            if (current.includes(val)) current = current.filter(x => x !== val);
            else current.push(val);
            library[activeTestId].progress[activeSection][qIdx].userAns = current;
            renderQuestions();
        }

        function updateText(qIdx, val) {
            initSectionProgress();
            library[activeTestId].progress[activeSection][qIdx].userAns = val;
        }

        function initSectionProgress() {
            if (!library[activeTestId].progress) {
                library[activeTestId].progress = {};
            }
            if (!library[activeTestId].progress[activeSection]) {
                library[activeTestId].progress[activeSection] = {};
            }
            const sectionAnswers = library[activeTestId].key[activeSection].answers;
            sectionAnswers.forEach((_, i) => {
                if (!library[activeTestId].progress[activeSection][i]) {
                    const type = library[activeTestId].key[activeSection].type;
                    library[activeTestId].progress[activeSection][i] = { userAns: type === 'multi' ? [] : "", submitted: false, marked: false, starred: false };
                }
            });
        }

        function submitQuestion(qIdx) {
            initSectionProgress();
            const q = library[activeTestId].progress[activeSection][qIdx];
            const actualAns = library[activeTestId].key[activeSection].answers[qIdx];

            const hasAns = Array.isArray(q.userAns) ? q.userAns.length > 0 : (q.userAns && q.userAns.toString().trim() !== "");
            if (!hasAns) {
                alert("Please select/enter an answer first.");
                return;
            }

            q.submitted = true;
            q.correct = compareAnswers(q.userAns, actualAns);
            saveAndSync();
            renderQuestions();
        }

        function submitAllAttempted() {
            if (!activeTestId || !activeSection) return;
            initSectionProgress();

            const test = library[activeTestId];
            const sectionKey = test.key[activeSection];
            const progress = test.progress[activeSection];
            let count = 0;

            sectionKey.answers.forEach((ans, idx) => {
                const q = progress[idx];
                if (q && !q.submitted) {
                    const hasAns = Array.isArray(q.userAns) ? q.userAns.length > 0 : (q.userAns && q.userAns.toString().trim() !== "");
                    if (hasAns) {
                        q.submitted = true;
                        q.correct = compareAnswers(q.userAns, ans);
                        count++;
                    }
                }
            });

            if (count > 0) {
                saveAndSync();
                renderQuestions();
            } else {
                alert("No new attempted questions to submit in this section.");
            }
        }

        // --- Library Export/Import ---
        function exportLibrary() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(library));
            const dlNode = document.createElement('a');
            dlNode.setAttribute("href", dataStr);
            dlNode.setAttribute("download", `study_portal_full_backup_${Date.now()}.json`);
            dlNode.click();
        }

        function exportSingleTest(id) {
            const test = library[id];
            if (!test) return;
            const singleTestData = { [id]: test };
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(singleTestData));
            const dlNode = document.createElement('a');
            dlNode.setAttribute("href", dataStr);
            dlNode.setAttribute("download", `${test.title.replace(/\s+/g, '_')}_backup.json`);
            dlNode.click();
        }

        function downloadOriginalKey(id) {
            const test = library[id];
            if (!test) return;
            const originalKey = test.key;
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(originalKey, null, 2));
            const dlNode = document.createElement('a');
            dlNode.setAttribute("href", dataStr);
            dlNode.setAttribute("download", `${test.title.replace(/\s+/g, '_')}_original_key.json`);
            dlNode.click();
        }

        function openKeyViewer(id) {
            const test = library[id];
            if (!test) return;
            const titleEl = document.getElementById('keyViewerTitle');
            const contentEl = document.getElementById('keyViewerContent');
            const downloadBtn = document.getElementById('downloadKeyBtn');

            titleEl.innerText = `Answer Key: ${test.title}`;
            contentEl.innerHTML = '';

            Object.keys(test.key).forEach(sectionName => {
                const section = test.key[sectionName];
                const sectionDiv = document.createElement('div');
                sectionDiv.className = 'bg-slate-50 dark:bg-slate-800/50 p-4 rounded-xl border border-slate-100 dark:border-slate-800';

                const sectionHeader = document.createElement('h4');
                sectionHeader.className = 'font-bold text-slate-700 dark:text-slate-300 mb-3 uppercase tracking-wider text-xs';
                sectionHeader.innerText = sectionName;
                sectionDiv.appendChild(sectionHeader);

                const grid = document.createElement('div');
                grid.className = 'grid grid-cols-2 sm:grid-cols-4 md:grid-cols-5 gap-3';

                section.answers.forEach((ans, idx) => {
                    const item = document.createElement('div');
                    item.className = 'text-[11px] flex flex-col items-center bg-white dark:bg-slate-800 p-2 rounded border border-slate-200 dark:border-slate-700';
                    item.innerHTML = `<span class="text-slate-400 dark:text-slate-500 font-bold mb-1">Q${idx + 1}</span> <span class="text-slate-800 dark:text-slate-200 font-black">${ans}</span>`;
                    grid.appendChild(item);
                });

                sectionDiv.appendChild(grid);
                contentEl.appendChild(sectionDiv);
            });

            downloadBtn.onclick = () => downloadOriginalKey(id);

            const modal = document.getElementById('keyViewerModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function importLibrary(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const imported = JSON.parse(e.target.result);
                    if (typeof imported !== 'object') throw new Error("Format error");
                    library = { ...library, ...imported };
                    saveAndSync();
                    renderLibrary();
                    alert("Library merged successfully.");
                } catch (err) { alert("Invalid backup file."); }
            };
            reader.readAsText(file);
        }

        // --- Reporting ---
        function showReport() {
            const test = library[activeTestId];
            if (!test) return;
            const content = document.getElementById('reportContent');
            content.innerHTML = '';

            let total = 0, totalCorrect = 0, totalAttempted = 0, totalIncorrect = 0;
            const sectionRows = [];

            Object.keys(test.key).forEach(s => {
                const sAns = test.key[s].answers;
                const sProg = test.progress ? (test.progress[s] || {}) : {};
                let sCorrect = 0, sAttempted = 0, sIncorrect = 0;

                sAns.forEach((_, idx) => {
                    const q = sProg[idx];
                    if (q && q.submitted) {
                        sAttempted++;
                        if (q.correct) sCorrect++;
                        else sIncorrect++;
                    }
                });

                total += sAns.length;
                totalCorrect += sCorrect;
                totalAttempted += sAttempted;
                totalIncorrect += sIncorrect;

                const row = document.createElement('div');
                row.className = 'bg-slate-50 dark:bg-slate-800/50 p-4 rounded-xl border border-slate-100 dark:border-slate-800';
                row.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-bold text-slate-700 dark:text-slate-300">${s}</span>
                        <span class="text-xs font-black px-2 py-1 bg-slate-200 dark:bg-slate-800 rounded uppercase tracking-tighter dark:text-slate-400">Section</span>
                    </div>
                    <div class="grid grid-cols-3 gap-2 text-center text-xs">
                        <div class="bg-blue-50 dark:bg-blue-900/20 p-2 rounded">
                            <div class="text-slate-400 dark:text-slate-500 font-medium mb-1">Attempted</div>
                            <div class="text-blue-600 dark:text-blue-400 font-bold">${sAttempted} / ${sAns.length}</div>
                        </div>
                        <div class="bg-emerald-50 dark:bg-emerald-900/20 p-2 rounded">
                            <div class="text-slate-400 dark:text-slate-500 font-medium mb-1">Correct</div>
                            <div class="text-emerald-600 dark:text-emerald-400 font-bold">${sCorrect}</div>
                        </div>
                        <div class="bg-rose-50 dark:bg-rose-900/20 p-2 rounded">
                            <div class="text-slate-400 dark:text-slate-500 font-medium mb-1">Incorrect</div>
                            <div class="text-rose-600 dark:text-rose-400 font-bold">${sIncorrect}</div>
                        </div>
                    </div>
                `;
                sectionRows.push(row);
            });

            const pct = total > 0 ? Math.round((totalCorrect / total) * 100) : 0;
            const summary = document.createElement('div');
            summary.className = 'bg-slate-900 dark:bg-black text-white rounded-2xl p-6 mb-6';
            summary.innerHTML = `
                <div class="flex flex-col md:flex-row justify-between items-center gap-6">
                    <div class="text-center md:text-left">
                        <h4 class="text-5xl font-black mb-1">${pct}%</h4>
                        <p class="text-slate-400 text-sm font-medium uppercase tracking-widest">Final Score</p>
                    </div>
                    <div class="h-px w-full md:h-12 md:w-px bg-slate-700 dark:bg-slate-800"></div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-8 flex-1 w-full text-center">
                        <div>
                            <div class="text-2xl font-bold">${totalAttempted}</div>
                            <div class="text-[10px] text-slate-400 uppercase font-bold tracking-widest">Attempted</div>
                        </div>
                        <div>
                            <div class="text-2xl font-bold text-emerald-400">${totalCorrect}</div>
                            <div class="text-[10px] text-slate-400 uppercase font-bold tracking-widest">Correct</div>
                        </div>
                        <div>
                            <div class="text-2xl font-bold text-rose-400">${totalIncorrect}</div>
                            <div class="text-[10px] text-slate-400 uppercase font-bold tracking-widest">Incorrect</div>
                        </div>
                        <div>
                            <div class="text-2xl font-bold text-blue-400 font-mono">${formatTime(test.timeSpent || 0)}</div>
                            <div class="text-[10px] text-slate-400 uppercase font-bold tracking-widest">Time Spent</div>
                        </div>
                    </div>
                </div>
                ${test.sessionGoal > 0 ? `
                <div class="mt-4 pt-4 border-t border-slate-700 dark:border-slate-800 flex justify-between items-center text-xs">
                    <span class="text-slate-400 font-bold uppercase tracking-widest">Session Goal Performance</span>
                    <span class="${totalAttempted >= test.sessionGoal ? 'text-emerald-400' : 'text-rose-400'} font-black">
                        ${totalAttempted} / ${test.sessionGoal} Questions Attempted
                    </span>
                </div>` : ''}
            `;

            content.appendChild(summary);
            const gridContainer = document.createElement('div');
            gridContainer.className = 'grid grid-cols-1 md:grid-cols-2 gap-4';
            sectionRows.forEach(row => gridContainer.appendChild(row));
            content.appendChild(gridContainer);

            const modal = document.getElementById('reportModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closeModal(id) {
            const modal = document.getElementById(id);
            if (modal) {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }
        }
    </script>
</body>

</html>
